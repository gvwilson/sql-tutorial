<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>The Querynomicon &middot; Odds and Ends</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script defer data-domain="gvwilson.github.io/sql-tutorial" src="https://plausible.io/js/plausible.js"></script>


  </head>
  <body>
    <main>
      <div class="row notex">
  <div class="col-12 center">
    
      <h1>Odds and Ends</h1>
    
  </div>
</div>

      
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../moretools/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../composite/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


      
      <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#gl:alias" markdown="1">alias</a>, <a class="gl-ref" href="../glossary/#gl:correlated_subquery" markdown="1">correlated subquery</a>, <a class="gl-ref" href="../glossary/#gl:index" markdown="1">index</a>, <a class="gl-ref" href="../glossary/#gl:table_valued_func" markdown="1">table-valued function</a>, <a class="gl-ref" href="../glossary/#gl:window_func" markdown="1">window function</a>
</p>
      <h2>Selecting First and Last Rows</h2>
<div class="language-sql" title="union_all.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="union_all.out">
<div class="highlight"><pre><span></span><code>| ident |    kind     |  started   |   ended    |
|-------|-------------|------------|------------|
| 17    | trial       | 2023-01-29 | 2023-01-30 |
| 35    | calibration | 2023-01-30 | 2023-01-30 |
| 36    | trial       | 2023-02-02 | 2023-02-03 |
| 25    | trial       | 2023-02-12 | 2023-02-14 |
| 2     | calibration | 2023-02-14 | 2023-02-14 |
| 40    | calibration | 2024-01-21 | 2024-01-21 |
| 12    | trial       | 2024-01-26 | 2024-01-28 |
| 44    | trial       | 2024-01-27 | 2024-01-29 |
| 34    | trial       | 2024-02-01 | 2024-02-02 |
| 14    | calibration | 2024-02-03 | 2024-02-03 |
</code></pre></div>
</div>
<ul>
<li><code>union all</code> combines records<ul>
<li>Keeps duplicates: <code>union</code> on its own only keeps unique records</li>
<li>Which is more work but sometimes more useful</li>
</ul>
</li>
<li>Yes, it feels like the extra <code>select * from</code> should be unnecessary</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a query whose result includes two rows for each Adelie penguin
in the <code>penguins</code> database.
How can you check that your query is working correctly?</p>
<h2>Intersection</h2>
<div class="language-sql" title="intersect.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">intersect</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="intersect.out">
<div class="highlight"><pre><span></span><code>| personal |  family   | dept | age |
|----------|-----------|------|-----|
| Indrans  | Sridhar   | mb   | 47  |
| Ishaan   | Ramaswamy | mb   | 35  |
</code></pre></div>
</div>
<ul>
<li>Rows involved must have the same structure</li>
<li>Intersection usually used when pulling values from different sources<ul>
<li>In the query above, would be clearer to use <code>where</code></li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use <code>intersect</code> to find all Adelie penguins that weigh more than 4000 grams.
How can you check that your query is working correctly?</p>
<p>Use <code>explain query plan</code> to compare the <code>intersect</code>-based query you just wrote
with one that uses <code>where</code>.
Which query looks like it will be more efficient?
Why do you believe this?</p>
<h2>Exclusion</h2>
<div class="language-sql" title="except.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">except</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">personal</span><span class="p">,</span>
<span class="w">        </span><span class="n">family</span><span class="p">,</span>
<span class="w">        </span><span class="n">dept</span><span class="p">,</span>
<span class="w">        </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="except.out">
<div class="highlight"><pre><span></span><code>| personal | family | dept | age |
|----------|--------|------|-----|
| Pranay   | Khanna | mb   | 51  |
</code></pre></div>
</div>
<ul>
<li>Again, tables must have same structure<ul>
<li>And this would be clearer with <code>where</code></li>
</ul>
</li>
<li>SQL operates on sets, not tables, except where it doesn&rsquo;t</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use <code>exclude</code> to find all Gentoo penguins that <em>aren&rsquo;t</em> male.
How can you check that your query is working correctly?</p>
<h2>Random Numbers and Why Not</h2>
<div class="language-sql" title="random_numbers.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">decorated</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="k">abs</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">selector</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">decorated</span>
<span class="k">where</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="random_numbers.out">
<div class="highlight"><pre><span></span><code>|         rand         | selector |      name      |
|----------------------|----------|----------------|
| 1175447513360584797  | 6        | Divit Dhaliwal |
| -1544776661445066577 | 5        | Pranay Khanna  |
| -9091755230464281578 | 1        | Riaan Dua      |
| -3436533101074958267 | 6        | Romil Kapoor   |
| -1361395956632904964 | 7        | Nitya Lal      |
</code></pre></div>
</div>
<ul>
<li>There is no way to seed SQLite&rsquo;s random number generator</li>
<li>Which means there is no way to reproduce its pseudo-random sequences</li>
<li>Which means you should <em>never</em> use it<ul>
<li>How are you going to debug something you can&rsquo;t re-run?</li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a query that:</p>
<ul>
<li>
<p>uses a CTE to create 1000 random numbers between 0 and 10 inclusive;</p>
</li>
<li>
<p>uses a second CTE to calculate their mean; and</p>
</li>
<li>
<p>uses a third CTE and <a href="https://www.sqlite.org/lang_mathfunc.html">SQLite&rsquo;s built-in math functions</a>
    to calculate their standard deviation.</p>
</li>
</ul>
<h2>Creating an Index</h2>
<div class="language-sql" title="create_use_index.sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">plate_file</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">plate</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

<span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="create_use_index.out">
<div class="highlight"><pre><span></span><code>QUERY PLAN
`--SCAN plate USING COVERING INDEX sqlite_autoindex_plate_1
QUERY PLAN
`--SCAN plate USING COVERING INDEX plate_file
</code></pre></div>
</div>
<ul>
<li>An <a class="gl-ref" href="../glossary/#gl:index" markdown="1">index</a> is an auxiliary data structure that enables faster access to records<ul>
<li>Spend storage space to buy speed</li>
</ul>
</li>
<li>Don&rsquo;t have to mention it explicitly in queries<ul>
<li>Database manager will use it automatically</li>
</ul>
</li>
<li>Unlike primary keys, SQLite supports defining indexes after the fact</li>
</ul>
<h2>Generating Sequences</h2>
<div class="language-sql" title="generate_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="generate_sequence.out">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>A (non-standard) <a class="gl-ref" href="../glossary/#gl:table_valued_func" markdown="1">table-valued function</a></li>
</ul>
<h2>Generating Sequences Based on Data</h2>
<div class="language-sql" title="data_range_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="data_range_sequence.out">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>Must have the parentheses around the <code>min</code> and <code>max</code> selections to keep SQLite happy</li>
</ul>
<h2>Generating Sequences of Dates</h2>
<div class="language-sql" title="date_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="date_sequence.out">
<div class="highlight"><pre><span></span><code>|  some_day  |
|------------|
| 2023-01-29 |
| 2023-01-30 |
| 2023-01-31 |
| 2023-02-01 |
| 2023-02-02 |
</code></pre></div>
</div>
<ul>
<li>SQLite represents dates as YYYY-MM-DD strings
    or as Julian days or as Unix milliseconds orâ€¦<ul>
<li>Julian days is fractional number of days since November 24, 4714 BCE</li>
</ul>
</li>
<li><code>julianday</code> and <code>date</code> convert back and forth</li>
<li><code>julianday</code> is specific to SQLite<ul>
<li>Other databases have their own date handling functions</li>
</ul>
</li>
</ul>
<h2>Counting Experiments Started per Day Without Gaps</h2>
<div class="language-sql" title="experiments_per_day.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="c1">-- complete sequence of days with 0 as placeholder for number of experiments</span>
<span class="n">all_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zeroes</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">),</span>

<span class="c1">-- sequence of actual days with actual number of experiments started</span>
<span class="n">actual_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">started</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span>
<span class="p">)</span>

<span class="c1">-- combined by joining on day and taking actual number (if available) or zero</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">day</span><span class="p">,</span>
<span class="w">    </span><span class="k">coalesce</span><span class="p">(</span><span class="n">actual_days</span><span class="p">.</span><span class="n">num_exp</span><span class="p">,</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">zeroes</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="k">from</span>
<span class="w">    </span><span class="n">all_days</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">actual_days</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual_days</span><span class="p">.</span><span class="n">started</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="experiments_per_day.out">
<div class="highlight"><pre><span></span><code>|    day     | num_exp |
|------------|---------|
| 2023-01-29 | 1       |
| 2023-01-30 | 1       |
| 2023-01-31 | 0       |
| 2023-02-01 | 0       |
| 2023-02-02 | 1       |
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>What does the expression <code>date('now', 'start of month', '+1 month', '-1 day')</code> produce?
(You may find <a href="https://www.sqlite.org/lang_datefunc.html">the documentation on SQLite&rsquo;s date and time functions</a> helpful.)</p>
<h2>Self Join</h2>
<div class="language-sql" title="self_join.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="self_join.out">
<div class="highlight"><pre><span></span><code>|     name     |       name       |
|--------------|------------------|
| Kartik Gupta | Kartik Gupta     |
| Kartik Gupta | Divit Dhaliwal   |
| Kartik Gupta | Indrans Sridhar  |
| Kartik Gupta | Pranay Khanna    |
| Kartik Gupta | Riaan Dua        |
| Kartik Gupta | Vedika Rout      |
| Kartik Gupta | Abram Chokshi    |
| Kartik Gupta | Romil Kapoor     |
| Kartik Gupta | Ishaan Ramaswamy |
| Kartik Gupta | Nitya Lal        |
</code></pre></div>
</div>
<ul>
<li>Join a table to itself<ul>
<li>Use <code>as</code> to create <a class="gl-ref" href="../glossary/#gl:alias" markdown="1">aliases</a> for copies of tables to distinguish them</li>
<li>Nothing special about the names <code>left</code> and <code>right</code></li>
</ul>
</li>
<li>Get all \( n^2 \) pairs, including person with themself</li>
</ul>
<h2>Generating Unique Pairs</h2>
<div class="language-sql" title="unique_pairs.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span>
<span class="k">where</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="unique_pairs.out">
<div class="highlight"><pre><span></span><code>|      name       |      name       |
|-----------------|-----------------|
| Kartik Gupta    | Divit Dhaliwal  |
| Kartik Gupta    | Indrans Sridhar |
| Kartik Gupta    | Pranay Khanna   |
| Divit Dhaliwal  | Indrans Sridhar |
| Divit Dhaliwal  | Pranay Khanna   |
| Indrans Sridhar | Pranay Khanna   |
</code></pre></div>
</div>
<ul>
<li><code>left.ident &lt; right.ident</code> ensures distinct pairs without duplicates<ul>
<li>Query uses <code>left.ident &lt;= 4 and right.ident &lt;= 4</code> to shorten output</li>
</ul>
</li>
<li>Quick check: \( n(n-1)/2 \) pairs</li>
</ul>
<h2>Filtering Pairs</h2>
<div class="language-sql" title="filter_pairs.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">),</span>

<span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">left_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_staff</span><span class="p">,</span>
<span class="w">        </span><span class="n">right_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_staff</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_perf</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_perf</span>
<span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="n">left_perf</span><span class="p">.</span><span class="n">experiment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_perf</span><span class="p">.</span><span class="n">experiment</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_1</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_2</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">together</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_staff</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="filter_pairs.out">
<div class="highlight"><pre><span></span><code>|    person_1     |     person_2     |
|-----------------|------------------|
| Kartik Gupta    | Vedika Rout      |
| Pranay Khanna   | Vedika Rout      |
| Indrans Sridhar | Romil Kapoor     |
| Abram Chokshi   | Ishaan Ramaswamy |
| Pranay Khanna   | Vedika Rout      |
| Kartik Gupta    | Abram Chokshi    |
| Abram Chokshi   | Romil Kapoor     |
| Kartik Gupta    | Divit Dhaliwal   |
| Divit Dhaliwal  | Abram Chokshi    |
| Pranay Khanna   | Ishaan Ramaswamy |
| Indrans Sridhar | Romil Kapoor     |
| Kartik Gupta    | Ishaan Ramaswamy |
| Kartik Gupta    | Nitya Lal        |
| Kartik Gupta    | Abram Chokshi    |
| Pranay Khanna   | Romil Kapoor     |
</code></pre></div>
</div>
<h2>Existence and Correlated Subqueries</h2>
<div class="language-sql" title="correlated_subquery.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="correlated_subquery.out">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>Endocrinology is missing from the list</li>
<li><code>select 1</code> could equally be <code>select true</code> or any other value</li>
<li>A <a class="gl-ref" href="../glossary/#gl:correlated_subquery" markdown="1">correlated subquery</a> depends on a value from the outer query<ul>
<li>Equivalent to nested loop</li>
</ul>
</li>
</ul>
<h2>Nonexistence</h2>
<div class="language-sql" title="nonexistence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="nonexistence.out">
<div class="highlight"><pre><span></span><code>|     name      | building |
|---------------|----------|
| Endocrinology | TGVH     |
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>Can you rewrite the previous query using <code>exclude</code>?
If so, is your new query easier to understand?
If the query cannot be rewritten, why not?</p>
<h2 class="aside">Avoiding Correlated Subqueries</h2>
<div class="language-sql" title="avoid_correlated_subqueries.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">building</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">staff</span><span class="p">.</span><span class="n">dept</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="avoid_correlated_subqueries.out">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>The join might or might not be faster than the correlated subquery</li>
<li>Hard to find unstaffed departments without either <code>not exists</code> or <code>count</code> and a check for 0</li>
</ul>
<h2>Lead and Lag</h2>
<div class="language-sql" title="lead_lag.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">lag</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_num</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="n">lead</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_num</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="lead_lag.out">
<div class="highlight"><pre><span></span><code>|   ym    | prev_num | num | next_num |
|---------|----------|-----|----------|
| 2023-01 |          | 2   | 5        |
| 2023-02 | 2        | 5   | 5        |
| 2023-03 | 5        | 5   | 1        |
| 2023-04 | 5        | 1   | 6        |
| 2023-05 | 1        | 6   | 5        |
| 2023-06 | 6        | 5   | 3        |
| 2023-07 | 5        | 3   | 2        |
| 2023-08 | 3        | 2   | 4        |
| 2023-09 | 2        | 4   | 6        |
| 2023-10 | 4        | 6   | 4        |
| 2023-12 | 6        | 4   | 5        |
| 2024-01 | 4        | 5   | 2        |
| 2024-02 | 5        | 2   |          |
</code></pre></div>
</div>
<ul>
<li>Use <code>strftime</code> to extract year and month<ul>
<li>Clumsy, but date/time handling is not SQLite&rsquo;s strong point</li>
</ul>
</li>
<li>Use <a class="gl-ref" href="../glossary/#gl:window_func" markdown="1">window functions</a> <code>lead</code> and <code>lag</code> to shift values<ul>
<li>Unavailable values at the top or bottom are null</li>
</ul>
</li>
</ul>
<h2 class="aside">Boundaries</h2>
<ul>
<li><a href="https://sqlite.org/windowfunctions.html">Documentation on SQLite&rsquo;s window functions</a> describes
    three frame types and five kinds of frame boundary</li>
<li>It feels very ad hoc, but so does the real world</li>
</ul>
<h2>Windowing Functions</h2>
<div class="language-sql" title="window_functions.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ym_num</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">completed_progress</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">linear_progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="window_functions.out">
<div class="highlight"><pre><span></span><code>|   ym    | num | num_done | completed_progress |  linear_progress   |
|---------|-----|----------|--------------------|--------------------|
| 2023-01 | 2   | 2        | 0.04               | 0.0769230769230769 |
| 2023-02 | 5   | 7        | 0.14               | 0.153846153846154  |
| 2023-03 | 5   | 12       | 0.24               | 0.230769230769231  |
| 2023-04 | 1   | 13       | 0.26               | 0.307692307692308  |
| 2023-05 | 6   | 19       | 0.38               | 0.384615384615385  |
| 2023-06 | 5   | 24       | 0.48               | 0.461538461538462  |
| 2023-07 | 3   | 27       | 0.54               | 0.538461538461538  |
| 2023-08 | 2   | 29       | 0.58               | 0.615384615384615  |
| 2023-09 | 4   | 33       | 0.66               | 0.692307692307692  |
| 2023-10 | 6   | 39       | 0.78               | 0.769230769230769  |
| 2023-12 | 4   | 43       | 0.86               | 0.846153846153846  |
| 2024-01 | 5   | 48       | 0.96               | 0.923076923076923  |
| 2024-02 | 2   | 50       | 1.0                | 1.0                |
</code></pre></div>
</div>
<ul>
<li><code>sum() over</code> does a running total</li>
<li><code>cume_dist()</code> is fraction <em>of rows seen so far</em></li>
<li>So <code>num_done</code> column is number of experiments doneâ€¦</li>
<li>â€¦<code>completed_progress</code> is the fraction of experiments doneâ€¦</li>
<li>â€¦and <code>linear_progress</code> is the fraction of time passed</li>
</ul>
<h2 class="aside">Explaining Another Query Plan</h2>
<div class="language-sql" title="explain_window_function.sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="explain_window_function.out">
<div class="highlight"><pre><span></span><code>QUERY PLAN
|--CO-ROUTINE (subquery-3)
|  |--CO-ROUTINE (subquery-4)
|  |  |--CO-ROUTINE ym_num
|  |  |  |--SCAN experiment
|  |  |  `--USE TEMP B-TREE FOR GROUP BY
|  |  |--SCAN ym_num
|  |  `--USE TEMP B-TREE FOR ORDER BY
|  `--SCAN (subquery-4)
`--SCAN (subquery-3)
</code></pre></div>
</div>
<ul>
<li>Becomes usefulâ€¦eventually</li>
</ul>
<h2>Partitioned Windows</h2>
<div class="language-sql" title="partition_window.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">y_m_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">year</span><span class="p">,</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="k">year</span><span class="p">,</span>
<span class="w">    </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span>
<span class="k">from</span><span class="w"> </span><span class="n">y_m_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="partition_window.out">
<div class="highlight"><pre><span></span><code>| year | month | num | num_done |
|------|-------|-----|----------|
| 2023 | 01    | 2   | 2        |
| 2023 | 02    | 5   | 7        |
| 2023 | 03    | 5   | 12       |
| 2023 | 04    | 1   | 13       |
| 2023 | 05    | 6   | 19       |
| 2023 | 06    | 5   | 24       |
| 2023 | 07    | 3   | 27       |
| 2023 | 08    | 2   | 29       |
| 2023 | 09    | 4   | 33       |
| 2023 | 10    | 6   | 39       |
| 2023 | 12    | 4   | 43       |
| 2024 | 01    | 5   | 5        |
| 2024 | 02    | 2   | 7        |
</code></pre></div>
</div>
<ul>
<li><code>partition by</code> creates groups</li>
<li>So this counts experiments started since the beginning of each year</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Create a query that:</p>
<ol>
<li>
<p>finds the unique weights of the penguins in the <code>penguins</code> database;</p>
</li>
<li>
<p>sorts them;</p>
</li>
<li>
<p>finds the difference between each successive distinct weight; and</p>
</li>
<li>
<p>counts how many times each unique difference appears.</p>
</li>
</ol>
    </main>
    <footer>
  Â© 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sql-tutorial">repository</a>
  &middot;
  <a href="../license/">license</a>
</footer>

  </body>
</html>
