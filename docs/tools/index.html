<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>The Querynomicon &middot; Tools</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script defer data-domain="gvwilson.github.io/sql-tutorial" src="https://plausible.io/js/plausible.js"></script>


  </head>
  <body>
    <main>
      <div class="row notex">
  <div class="col-12 center">
    
      <h1>Tools</h1>
    
  </div>
</div>

      
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../core/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../advanced/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


      
      <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#gl:1_to_1" markdown="1">1-to-1 relation</a>, <a class="gl-ref" href="../glossary/#gl:1_to_many" markdown="1">1-to-many relation</a>, <a class="gl-ref" href="../glossary/#gl:alias" markdown="1">alias</a>, <a class="gl-ref" href="../glossary/#gl:autoincrement" markdown="1">autoincrement</a>, <a class="gl-ref" href="../glossary/#gl:b_tree" markdown="1">B-tree</a>, <a class="gl-ref" href="../glossary/#gl:correlated_subquery" markdown="1">correlated subquery</a>, <a class="gl-ref" href="../glossary/#gl:cte" markdown="1">common table expression</a>, <a class="gl-ref" href="../glossary/#gl:data_migration" markdown="1">data migration</a>, <a class="gl-ref" href="../glossary/#gl:er_diagram" markdown="1">entity-relationship diagram</a>, <a class="gl-ref" href="../glossary/#gl:expression" markdown="1">expression</a>, <a class="gl-ref" href="../glossary/#gl:foreign_key" markdown="1">foreign key</a>, <a class="gl-ref" href="../glossary/#gl:index" markdown="1">index</a>, <a class="gl-ref" href="../glossary/#gl:join_table" markdown="1">join table</a>, <a class="gl-ref" href="../glossary/#gl:many_to_many" markdown="1">many-to-many relation</a>, <a class="gl-ref" href="../glossary/#gl:primary_key" markdown="1">primary key</a>, <a class="gl-ref" href="../glossary/#gl:statement" markdown="1">statement</a>, <a class="gl-ref" href="../glossary/#gl:subquery" markdown="1">subquery</a>, <a class="gl-ref" href="../glossary/#gl:table_valued_func" markdown="1">table-valued function</a>, <a class="gl-ref" href="../glossary/#gl:vectorization" markdown="1">vectorization</a>, <a class="gl-ref" href="../glossary/#gl:window_func" markdown="1">window function</a>
</p>
      <h2>Negating Incorrectly</h2>
<ul>
<li>Who doesn&rsquo;t calibrate?</li>
</ul>
<div class="language-sql" title="negate_incorrectly.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="negate_incorrectly.out">
<div class="highlight"><pre><span></span><code>| person |
|--------|
| mik    |
| po     |
| tay    |
</code></pre></div>
</div>
<ul>
<li>But Mik <em>does</em> calibrate</li>
<li>Problem is that there&rsquo;s an entry for Mik cleaning</li>
<li>And since <code>'clean' != 'calibrate'</code>, that row is included in the results</li>
<li>We need a different approachâ€¦</li>
</ul>
<h2>Set Membership</h2>
<div class="language-sql" title="set_membership.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;mik&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tay&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="set_membership.out">
<div class="highlight"><pre><span></span><code>| person |   job    |
|--------|----------|
| po     | clean    |
| po     | complain |
</code></pre></div>
</div>
<ul>
<li><code>in <em>values</em></code> and <code>not in <em>values</em></code> do exactly what you expect</li>
</ul>
<h2>Subqueries</h2>
<div class="language-sql" title="subquery_set.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span>
<span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="subquery_set.out">
<div class="highlight"><pre><span></span><code>| person |
|--------|
| po     |
| tay    |
</code></pre></div>
</div>
<ul>
<li>Use a <a class="gl-ref" href="../glossary/#gl:subquery" markdown="1">subquery</a> to select the people who <em>do</em> calibrate</li>
<li>Then select all the people who <em>aren&rsquo;t</em> in that set</li>
<li>Initially feels odd, but subqueries are useful in other ways</li>
</ul>
<h2 class="aside">Defining a Primary Key</h2>
<ul>
<li>Can use any field (or combination of fields) in a table as a <a class="gl-ref" href="../glossary/#gl:primary_key" markdown="1">primary key</a>
    as long as value(s) unique for each record</li>
<li>Uniquely identifies a particular record in a particular table</li>
</ul>
<div class="language-sql" title="primary_key.sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">size</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">lab_equipment</span><span class="p">;</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="primary_key.out">
<div class="highlight"><pre><span></span><code>| size | color | num |
|------|-------|-----|
| 1.5  | blue  | 2   |
| 1.5  | green | 1   |
| 2.5  | blue  | 1   |
Runtime error near line 17: UNIQUE constraint failed: lab_equipment.size, lab_equipment.color (19)
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>Does the <code>penguins</code> table have a primary key?
If so, what is it?
What about the <code>work</code> and <code>job</code> tables?</p>
<h2>Autoincrementing and Primary Keys</h2>
<div class="language-sql" title="autoincrement.sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">ident</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">autoincrement</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mik&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;po&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tay&#39;</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prevented&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="autoincrement.out">
<div class="highlight"><pre><span></span><code>| ident | name |
|-------|------|
| 1     | mik  |
| 2     | po   |
| 3     | tay  |
Runtime error near line 12: UNIQUE constraint failed: person.ident (19)
</code></pre></div>
</div>
<ul>
<li>Database <a class="gl-ref" href="../glossary/#gl:autoincrement" markdown="1">autoincrements</a> <code>ident</code> each time a new record is added</li>
<li>Common to use that field as the primary key<ul>
<li>Unique for each record</li>
</ul>
</li>
<li>If Mik changes their name again,
    we only have to change one fact in the database</li>
<li>Downside: manual queries are harder to read (who is person 17?)</li>
</ul>
<h2 class="aside">Internal Tables</h2>
<div class="language-sql" title="sequence_table.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sqlite_sequence</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="sequence_table.out">
<div class="highlight"><pre><span></span><code>|  name  | seq |
|--------|-----|
| person | 3   |
</code></pre></div>
</div>
<ul>
<li>Sequence numbers are <em>not</em> reset when rows are deleted<ul>
<li>In part so that they can be used as primary keys</li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Are you able to modify the values stored in <code>sqlite_sequence</code>?
In particular,
are you able to reset the values so that
the same sequence numbers are generated again?</p>
<h2>Altering Tables</h2>
<div class="language-sql" title="alter_tables.sql">
<div class="highlight"><pre><span></span><code><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span>
<span class="k">add</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">job</span>
<span class="k">set</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">job</span>
<span class="k">set</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;clean&#39;</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="alter_tables.out">
<div class="highlight"><pre><span></span><code>|   name    | billable | ident |
|-----------|----------|-------|
| calibrate | 1.5      | 1     |
| clean     | 0.5      | 2     |
</code></pre></div>
</div>
<ul>
<li>Add a column after the fact</li>
<li>Since it can&rsquo;t be null, we have to provide a default value<ul>
<li>Really want to make it the primary key, but SQLite doesn&rsquo;t allow that after the fact</li>
</ul>
</li>
<li>Then use <code>update</code> to modify existing records<ul>
<li>Can modify any number of records at once</li>
<li>So be careful about <code>where</code> clause</li>
</ul>
</li>
<li>An example of <a class="gl-ref" href="../glossary/#gl:data_migration" markdown="1">data migration</a></li>
</ul>
<h2 class="aside">M-to-N Relationships</h2>
<ul>
<li>Relationships between entities are usually characterized as:<ul>
<li><a class="gl-ref" href="../glossary/#gl:1_to_1" markdown="1">1-to-1</a>:
    fields in the same record</li>
<li><a class="gl-ref" href="../glossary/#gl:1_to_many" markdown="1">1-to-many</a>:
    the many have a <a class="gl-ref" href="../glossary/#gl:foreign_key" markdown="1">foreign key</a> referring to the one&rsquo;s primary key</li>
<li><a class="gl-ref" href="../glossary/#gl:many_to_many" markdown="1">many-to-many</a>:
    don&rsquo;t know how many keys to add to records (&ldquo;maximum&rdquo; never is)</li>
</ul>
</li>
<li>Nearly-universal solution is a <a class="gl-ref" href="../glossary/#gl:join_table" markdown="1">join table</a><ul>
<li>Each record is a pair of foreign keys</li>
<li>I.e., each record is the fact that records A and B are related</li>
</ul>
</li>
</ul>
<h2>Creating New Tables from Old</h2>
<div class="language-sql" title="insert_select.sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_work</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">job_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">(</span><span class="n">ident</span><span class="p">),</span>
<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">new_work</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">job_id</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">)</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="p">;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">new_work</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="insert_select.out">
<div class="highlight"><pre><span></span><code>| person_id | job_id |
|-----------|--------|
| 1         | 1      |
| 1         | 2      |
| 2         | 2      |
</code></pre></div>
</div>
<ul>
<li><code>new_work</code> is our join table</li>
<li>Each column refers to a record in some other table</li>
</ul>
<h2>Removing Tables</h2>
<div class="language-sql" title="drop_table.sql">
<div class="highlight"><pre><span></span><code><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">work</span><span class="p">;</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_work</span><span class="w"> </span><span class="k">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">work</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="drop_table.out">
<div class="highlight"><pre><span></span><code>CREATE TABLE job (
    ident integer primary key autoincrement,
    name text not null,
    billable real not null
);
CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person (
    ident integer primary key autoincrement,
    name text not null
);
CREATE TABLE IF NOT EXISTS &quot;work&quot; (
    person_id integer not null,
    job_id integer not null,
    foreign key(person_id) references person(ident),
    foreign key(job_id) references job(ident)
);
</code></pre></div>
</div>
<ul>
<li>Remove the old table and rename the new one to take its place<ul>
<li>Note <code>if exists</code></li>
</ul>
</li>
<li>Please back up your data first</li>
</ul>
<h2 class="exercise">Exercise</h2>
<ol>
<li>
<p>Reorganize the penguins database:</p>
<ol>
<li>Make a copy of the <code>penguins.db</code> file
    so that your changes won&rsquo;t affect the original.</li>
<li>Write a SQL script that reorganizes the data into three tables:
    one for each island.</li>
<li>Why is organizing data like this a bad idea?</li>
</ol>
</li>
<li>
<p>Tools like <a href="https://sqitch.org/">Sqitch</a> can manage changes to database schemas and data
    so that they can be saved in version control
    and rolled back if they are unsuccessful.
    Translate the changes made by the scripts above into Sqitch.
    Note: this exercise may take an hour or more.</p>
</li>
</ol>
<h2>Comparing Individual Values to Aggregates</h2>
<ul>
<li>Go back to the original penguins database</li>
</ul>
<div class="language-sql" title="compare_individual_aggregate.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">body_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="compare_individual_aggregate.out">
<div class="highlight"><pre><span></span><code>| body_mass_g |
|-------------|
| 4675.0      |
| 4250.0      |
| 4400.0      |
| 4500.0      |
| 4650.0      |
</code></pre></div>
</div>
<ul>
<li>Get average body mass in subquery</li>
<li>Compare each row against that</li>
<li>Requires two scans of the data, but no way to avoid that<ul>
<li>Except calculating a running total each time a penguin is added to the table</li>
</ul>
</li>
<li>Null values aren&rsquo;t included in the average or in the final results</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use a subquery to find the number of penguins
that weigh the same as the lightest penguin.</p>
<h2>Comparing Individual Values to Aggregates Within Groups</h2>
<div class="language-sql" title="compare_within_groups.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">averaged</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">averaged</span><span class="p">.</span><span class="n">species</span>
<span class="k">where</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="compare_within_groups.out">
<div class="highlight"><pre><span></span><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>
</div>
<ul>
<li>Subquery runs first to create temporary table <code>averaged</code> with average mass per species</li>
<li>Join that with <code>penguins</code></li>
<li>Filter to find penguins heavier than average within their species</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use a subquery to find the number of penguins
that weigh the same as the lightest penguin of the same sex and species.</p>
<h2>Common Table Expressions</h2>
<div class="language-sql" title="common_table_expressions.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">grouped</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">grouped</span>
<span class="k">where</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="common_table_expressions.out">
<div class="highlight"><pre><span></span><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>
</div>
<ul>
<li>Use <a class="gl-ref" href="../glossary/#gl:cte" markdown="1">common table expression</a> (CTE) to make queries clearer<ul>
<li>Nested subqueries quickly become difficult to understand</li>
</ul>
</li>
<li>Database decides how to optimize</li>
</ul>
<h2 class="aside">Explaining Query Plans</h2>
<div class="language-sql" title="explain_query_plan.sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="explain_query_plan.out">
<div class="highlight"><pre><span></span><code>QUERY PLAN
|--SCAN penguins
`--USE TEMP B-TREE FOR GROUP BY
</code></pre></div>
</div>
<ul>
<li>SQLite plans to scan every row of the table</li>
<li>It will build a temporary <a class="gl-ref" href="../glossary/#gl:b_tree" markdown="1">B-tree data structure</a> to group rows</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use a CTE to find
the number of penguins
that weigh the same as the lightest penguin of the same sex and species.</p>
<h2>Enumerating Rows</h2>
<ul>
<li>Every table has a special column called <code>rowid</code></li>
</ul>
<div class="language-sql" title="rowid.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">rowid</span><span class="p">,</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="rowid.out">
<div class="highlight"><pre><span></span><code>| rowid | species |  island   |
|-------|---------|-----------|
| 1     | Adelie  | Torgersen |
| 2     | Adelie  | Torgersen |
| 3     | Adelie  | Torgersen |
| 4     | Adelie  | Torgersen |
| 5     | Adelie  | Torgersen |
</code></pre></div>
</div>
<ul>
<li><code>rowid</code> is persistent within a session<ul>
<li>I.e., if we delete the first 5 rows we now have row IDs 6â€¦N</li>
</ul>
</li>
<li><em>Do not rely on row ID</em><ul>
<li>In particular, do not use it as a key</li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>To explore how row IDs behave:</p>
<ol>
<li>
<p>Suppose that you create a new table,
    add three rows,
    delete those rows,
    and add the same values again.
    Do you expect the row IDs of the final rows to be 1â€“3 or 4â€“6?</p>
</li>
<li>
<p>Using an in-memory database,
    perform the steps in part 1.
    Was the result what you expected?</p>
</li>
</ol>
<h2>Conditionals</h2>
<div class="language-sql" title="if_else.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="n">iif</span><span class="p">(</span>
<span class="w">            </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3500</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;large&#39;</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="if_else.out">
<div class="highlight"><pre><span></span><code>|  species  | size  | num |
|-----------|-------|-----|
| Adelie    | small | 54  |
| Adelie    | large | 97  |
| Chinstrap | small | 17  |
| Chinstrap | large | 51  |
| Gentoo    | large | 123 |
</code></pre></div>
</div>
<ul>
<li><code>iif(<em>condition</em>, <em>true_result</em>, <em>false_result</em>)</code><ul>
<li>Note: <code>iif</code> with two i&rsquo;s</li>
</ul>
</li>
<li>May feel odd to think of <code>if</code>/<code>else</code> as a function,
    but common in <a class="gl-ref" href="../glossary/#gl:vectorization" markdown="1">vectorized</a> calculations</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>How does the result of the previous query change
if the check for null body mass is removed?
Why is the result without that check misleading?</p>
<p>What does each of the expressions shown below produce?
Which ones do you think actually attempt to divide by zero?</p>
<ol>
<li><code>iif(0, 123, 1/0)</code></li>
<li><code>iif(1, 123, 1/0)</code></li>
<li><code>iif(0, 1/0, 123)</code></li>
<li><code>iif(1, 1/0, 123)</code></li>
</ol>
<h2>Selecting a Case</h2>
<ul>
<li>What if we want small, medium, and large?</li>
<li>Can nest <code>iif</code>, but quickly becomes unreadable</li>
</ul>
<div class="language-sql" title="case_when.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">case</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3500</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;small&#39;</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;medium&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;large&#39;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="case_when.out">
<div class="highlight"><pre><span></span><code>|  species  |  size  | num |
|-----------|--------|-----|
| Adelie    | small  | 54  |
| Adelie    | medium | 97  |
| Chinstrap | small  | 17  |
| Chinstrap | medium | 51  |
| Gentoo    | medium | 56  |
| Gentoo    | large  | 67  |
</code></pre></div>
</div>
<ul>
<li>Evaluate <code>when</code> options in order and take first</li>
<li>Result of <code>case</code> is null if no condition is true</li>
<li>Use <code>else</code> as fallback</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Modify the query above so that
the outputs are <code>"penguin is small"</code> and <code>"penguin is large"</code>
by concatenating the string <code>"penguin is "</code> to the entire <code>case</code>
rather than to the individual <code>when</code> branches.
(This exercise shows that <code>case</code>/<code>when</code> is an <a class="gl-ref" href="../glossary/#gl:expression" markdown="1">expression</a>
rather than a <a class="gl-ref" href="../glossary/#gl:statement" markdown="1">statement</a>.)</p>
<h2>Checking a Range</h2>
<div class="language-sql" title="check_range.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">case</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">3500</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;abnormal&#39;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="check_range.out">
<div class="highlight"><pre><span></span><code>|  species  |   size   | num |
|-----------|----------|-----|
| Adelie    | abnormal | 54  |
| Adelie    | normal   | 97  |
| Chinstrap | abnormal | 17  |
| Chinstrap | normal   | 51  |
| Gentoo    | abnormal | 61  |
| Gentoo    | normal   | 62  |
</code></pre></div>
</div>
<ul>
<li><code>between</code> can make queries easier to read</li>
<li>But be careful of the <code>and</code> in the middle</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>The expression <code>val between 'A' and 'Z'</code> is true if <code>val</code> is <code>'M'</code> (upper case)
but false if <code>val</code> is <code>'m'</code> (lower case).
Rewrite the expression using <a href="https://www.sqlite.org/lang_corefunc.html">SQLite&rsquo;s built-in scalar functions</a>
so that it is true in both cases.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>substr</code></td>
<td>Get substring given starting point and length</td>
</tr>
<tr>
<td><code>trim</code></td>
<td>Remove characters from beginning and end of string</td>
</tr>
<tr>
<td><code>ltrim</code></td>
<td>Remove characters from beginning of string</td>
</tr>
<tr>
<td><code>rtrim</code></td>
<td>Remove characters from end of string</td>
</tr>
<tr>
<td><code>length</code></td>
<td>Length of string</td>
</tr>
<tr>
<td><code>replace</code></td>
<td>Replace occurrences of substring with another string</td>
</tr>
<tr>
<td><code>upper</code></td>
<td>Return upper-case version of string</td>
</tr>
<tr>
<td><code>lower</code></td>
<td>Return lower-case version of string</td>
</tr>
<tr>
<td><code>instr</code></td>
<td>Find location of first occurrence of substring (returns 0 if not found)</td>
</tr>
</tbody>
</table>
<h2 class="aside">Yet Another Database</h2>
<ul>
<li><a class="gl-ref" href="../glossary/#gl:er_diagram" markdown="1">Entity-relationship diagram</a> (ER diagram) shows relationships between tables</li>
<li>Like everything to do with databases, there are lots of variations</li>
</ul>
<figure id="assays_tables">
<img src="./assays_tables.svg" alt="table-level diagram of assay database showing primary and foreign key relationships"/>
<figcaption>Figure&nbsp;3.1: assay database table diagram</figcaption>
</figure>

<figure id="assays_er">
<img src="./assays_er.svg" alt="entity-relationship diagram showing logical structure of assay database"/>
<figcaption>Figure&nbsp;3.2: assay ER diagram</figcaption>
</figure>

<div class="language-sql" title="assay_staff.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="assay_staff.out">
<div class="highlight"><pre><span></span><code>| ident | personal |  family   | dept | age |
|-------|----------|-----------|------|-----|
| 1     | Kartik   | Gupta     |      | 46  |
| 2     | Divit    | Dhaliwal  | hist | 34  |
| 3     | Indrans  | Sridhar   | mb   | 47  |
| 4     | Pranay   | Khanna    | mb   | 51  |
| 5     | Riaan    | Dua       |      | 23  |
| 6     | Vedika   | Rout      | hist | 45  |
| 7     | Abram    | Chokshi   | gen  | 23  |
| 8     | Romil    | Kapoor    | hist | 38  |
| 9     | Ishaan   | Ramaswamy | mb   | 35  |
| 10    | Nitya    | Lal       | gen  | 52  |
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>Draw a table diagram and an ER diagram to represent the following database:</p>
<ul>
<li><code>person</code> has <code>id</code> and <code>full_name</code></li>
<li><code>course</code> has <code>id</code> and <code>name</code></li>
<li><code>section</code> has <code>course_id</code>, <code>start_date</code>, and <code>end_date</code></li>
<li><code>instructor</code> has <code>person_id</code> and <code>section_id</code></li>
<li><code>student</code> has <code>person_id</code>, <code>section_id</code>, and <code>status</code></li>
</ul>
<h2>Pattern Matching</h2>
<div class="language-sql" title="like_glob.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">personal</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%ya%&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="like_glob.out">
<div class="highlight"><pre><span></span><code>| personal | family |
|----------|--------|
| Nitya    | Lal    |
</code></pre></div>
</div>
<ul>
<li><code>like</code> is the original SQL pattern matcher<ul>
<li><code>%</code> matches zero or more characters at the start or end of a string</li>
<li>Case insensitive by default</li>
</ul>
</li>
<li><code>glob</code> supports Unix-style wildcards</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Rewrite the pattern-matching query shown above using <code>glob</code>.</p>
<h2>Selecting First and Last Rows</h2>
<div class="language-sql" title="union_all.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="union_all.out">
<div class="highlight"><pre><span></span><code>| ident |    kind     |  started   |   ended    |
|-------|-------------|------------|------------|
| 17    | trial       | 2023-01-29 | 2023-01-30 |
| 35    | calibration | 2023-01-30 | 2023-01-30 |
| 36    | trial       | 2023-02-02 | 2023-02-03 |
| 25    | trial       | 2023-02-12 | 2023-02-14 |
| 2     | calibration | 2023-02-14 | 2023-02-14 |
| 40    | calibration | 2024-01-21 | 2024-01-21 |
| 12    | trial       | 2024-01-26 | 2024-01-28 |
| 44    | trial       | 2024-01-27 | 2024-01-29 |
| 34    | trial       | 2024-02-01 | 2024-02-02 |
| 14    | calibration | 2024-02-03 | 2024-02-03 |
</code></pre></div>
</div>
<ul>
<li><code>union all</code> combines records<ul>
<li>Keeps duplicates: <code>union</code> on its own only keeps unique records</li>
<li>Which is more work but sometimes more useful</li>
</ul>
</li>
<li>Yes, it feels like the extra <code>select * from</code> should be unnecessary</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a query whose result includes two rows for each Adelie penguin
in the <code>penguins</code> database.
How can you check that your query is working correctly?</p>
<h2>Intersection</h2>
<div class="language-sql" title="intersect.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">intersect</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="intersect.out">
<div class="highlight"><pre><span></span><code>| personal |  family   | dept | age |
|----------|-----------|------|-----|
| Indrans  | Sridhar   | mb   | 47  |
| Ishaan   | Ramaswamy | mb   | 35  |
</code></pre></div>
</div>
<ul>
<li>Rows involved must have the same structure</li>
<li>Intersection usually used when pulling values from different sources<ul>
<li>In the query above, would be clearer to use <code>where</code></li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use <code>intersect</code> to find all Adelie penguins that weigh more than 4000 grams.
How can you check that your query is working correctly?</p>
<p>Use <code>explain query plan</code> to compare the <code>intersect</code>-based query you just wrote
with one that uses <code>where</code>.
Which query looks like it will be more efficient?
Why do you believe this?</p>
<h2>Exclusion</h2>
<div class="language-sql" title="except.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">except</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">personal</span><span class="p">,</span>
<span class="w">        </span><span class="n">family</span><span class="p">,</span>
<span class="w">        </span><span class="n">dept</span><span class="p">,</span>
<span class="w">        </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="except.out">
<div class="highlight"><pre><span></span><code>| personal | family | dept | age |
|----------|--------|------|-----|
| Pranay   | Khanna | mb   | 51  |
</code></pre></div>
</div>
<ul>
<li>Again, tables must have same structure<ul>
<li>And this would be clearer with <code>where</code></li>
</ul>
</li>
<li>SQL operates on sets, not tables, except where it doesn&rsquo;t</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Use <code>exclude</code> to find all Gentoo penguins that <em>aren&rsquo;t</em> male.
How can you check that your query is working correctly?</p>
<h2>Random Numbers and Why Not</h2>
<div class="language-sql" title="random_numbers.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">decorated</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="k">abs</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">selector</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">decorated</span>
<span class="k">where</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="random_numbers.out">
<div class="highlight"><pre><span></span><code>|         rand         | selector |       name       |
|----------------------|----------|------------------|
| 4059949963152921941  | 6        | Kartik Gupta     |
| 1145655525811150392  | 4        | Indrans Sridhar  |
| -7379530782022961784 | 7        | Romil Kapoor     |
| 7454920825876216085  | 6        | Ishaan Ramaswamy |
</code></pre></div>
</div>
<ul>
<li>There is no way to seed SQLite&rsquo;s random number generator</li>
<li>Which means there is no way to reproduce its pseudo-random sequences</li>
<li>Which means you should <em>never</em> use it<ul>
<li>How are you going to debug something you can&rsquo;t re-run?</li>
</ul>
</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a query that:</p>
<ul>
<li>
<p>uses a CTE to create 1000 random numbers between 0 and 10 inclusive;</p>
</li>
<li>
<p>uses a second CTE to calculate their mean; and</p>
</li>
<li>
<p>uses a third CTE and <a href="https://www.sqlite.org/lang_mathfunc.html">SQLite&rsquo;s built-in math functions</a>
    to calculate their standard deviation.</p>
</li>
</ul>
<h2>Creating an Index</h2>
<div class="language-sql" title="create_use_index.sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">plate_file</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">plate</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

<span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="create_use_index.out">
<div class="highlight"><pre><span></span><code>QUERY PLAN
`--SCAN plate USING COVERING INDEX sqlite_autoindex_plate_1
QUERY PLAN
`--SCAN plate USING COVERING INDEX plate_file
</code></pre></div>
</div>
<ul>
<li>An <a class="gl-ref" href="../glossary/#gl:index" markdown="1">index</a> is an auxiliary data structure that enables faster access to records<ul>
<li>Spend storage space to buy speed</li>
</ul>
</li>
<li>Don&rsquo;t have to mention it explicitly in queries<ul>
<li>Database manager will use it automatically</li>
</ul>
</li>
<li>Unlike primary keys, SQLite supports defining indexes after the fact</li>
</ul>
<h2>Generating Sequences</h2>
<div class="language-sql" title="generate_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="generate_sequence.out">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>A (non-standard) <a class="gl-ref" href="../glossary/#gl:table_valued_func" markdown="1">table-valued function</a></li>
</ul>
<h2>Generating Sequences Based on Data</h2>
<div class="language-sql" title="data_range_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
</div>
<div class="language-out" title="data_range_sequence.out">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>Must have the parentheses around the <code>min</code> and <code>max</code> selections to keep SQLite happy</li>
</ul>
<h2>Generating Sequences of Dates</h2>
<div class="language-sql" title="date_sequence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="date_sequence.out">
<div class="highlight"><pre><span></span><code>|  some_day  |
|------------|
| 2023-01-29 |
| 2023-01-30 |
| 2023-01-31 |
| 2023-02-01 |
| 2023-02-02 |
</code></pre></div>
</div>
<ul>
<li>SQLite represents dates as YYYY-MM-DD strings
    or as Julian days or as Unix milliseconds orâ€¦<ul>
<li>Julian days is fractional number of days since November 24, 4714 BCE</li>
</ul>
</li>
<li><code>julianday</code> and <code>date</code> convert back and forth</li>
<li><code>julianday</code> is specific to SQLite<ul>
<li>Other databases have their own date handling functions</li>
</ul>
</li>
</ul>
<h2>Counting Experiments Started per Day Without Gaps</h2>
<div class="language-sql" title="experiments_per_day.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="c1">-- complete sequence of days with 0 as placeholder for number of experiments</span>
<span class="n">all_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zeroes</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">),</span>

<span class="c1">-- sequence of actual days with actual number of experiments started</span>
<span class="n">actual_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">started</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span>
<span class="p">)</span>

<span class="c1">-- combined by joining on day and taking actual number (if available) or zero</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">day</span><span class="p">,</span>
<span class="w">    </span><span class="k">coalesce</span><span class="p">(</span><span class="n">actual_days</span><span class="p">.</span><span class="n">num_exp</span><span class="p">,</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">zeroes</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="k">from</span>
<span class="w">    </span><span class="n">all_days</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">actual_days</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual_days</span><span class="p">.</span><span class="n">started</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="experiments_per_day.out">
<div class="highlight"><pre><span></span><code>|    day     | num_exp |
|------------|---------|
| 2023-01-29 | 1       |
| 2023-01-30 | 1       |
| 2023-01-31 | 0       |
| 2023-02-01 | 0       |
| 2023-02-02 | 1       |
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>What does the expression <code>date('now', 'start of month', '+1 month', '-1 day')</code> produce?
(You may find <a href="https://www.sqlite.org/lang_datefunc.html">the documentation on SQLite&rsquo;s date and time functions</a> helpful.)</p>
<h2>Self Join</h2>
<div class="language-sql" title="self_join.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="self_join.out">
<div class="highlight"><pre><span></span><code>|     name     |       name       |
|--------------|------------------|
| Kartik Gupta | Kartik Gupta     |
| Kartik Gupta | Divit Dhaliwal   |
| Kartik Gupta | Indrans Sridhar  |
| Kartik Gupta | Pranay Khanna    |
| Kartik Gupta | Riaan Dua        |
| Kartik Gupta | Vedika Rout      |
| Kartik Gupta | Abram Chokshi    |
| Kartik Gupta | Romil Kapoor     |
| Kartik Gupta | Ishaan Ramaswamy |
| Kartik Gupta | Nitya Lal        |
</code></pre></div>
</div>
<ul>
<li>Join a table to itself<ul>
<li>Use <code>as</code> to create <a class="gl-ref" href="../glossary/#gl:alias" markdown="1">aliases</a> for copies of tables to distinguish them</li>
<li>Nothing special about the names <code>left</code> and <code>right</code></li>
</ul>
</li>
<li>Get all \( n^2 \) pairs, including person with themself</li>
</ul>
<h2>Generating Unique Pairs</h2>
<div class="language-sql" title="unique_pairs.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span>
<span class="k">where</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="unique_pairs.out">
<div class="highlight"><pre><span></span><code>|      name       |      name       |
|-----------------|-----------------|
| Kartik Gupta    | Divit Dhaliwal  |
| Kartik Gupta    | Indrans Sridhar |
| Kartik Gupta    | Pranay Khanna   |
| Divit Dhaliwal  | Indrans Sridhar |
| Divit Dhaliwal  | Pranay Khanna   |
| Indrans Sridhar | Pranay Khanna   |
</code></pre></div>
</div>
<ul>
<li><code>left.ident &lt; right.ident</code> ensures distinct pairs without duplicates<ul>
<li>Query uses <code>left.ident &lt;= 4 and right.ident &lt;= 4</code> to shorten output</li>
</ul>
</li>
<li>Quick check: \( n(n-1)/2 \) pairs</li>
</ul>
<h2>Filtering Pairs</h2>
<div class="language-sql" title="filter_pairs.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">),</span>

<span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">left_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_staff</span><span class="p">,</span>
<span class="w">        </span><span class="n">right_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_staff</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_perf</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_perf</span>
<span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="n">left_perf</span><span class="p">.</span><span class="n">experiment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_perf</span><span class="p">.</span><span class="n">experiment</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_1</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_2</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">together</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_staff</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="filter_pairs.out">
<div class="highlight"><pre><span></span><code>|    person_1     |     person_2     |
|-----------------|------------------|
| Kartik Gupta    | Vedika Rout      |
| Pranay Khanna   | Vedika Rout      |
| Indrans Sridhar | Romil Kapoor     |
| Abram Chokshi   | Ishaan Ramaswamy |
| Pranay Khanna   | Vedika Rout      |
| Kartik Gupta    | Abram Chokshi    |
| Abram Chokshi   | Romil Kapoor     |
| Kartik Gupta    | Divit Dhaliwal   |
| Divit Dhaliwal  | Abram Chokshi    |
| Pranay Khanna   | Ishaan Ramaswamy |
| Indrans Sridhar | Romil Kapoor     |
| Kartik Gupta    | Ishaan Ramaswamy |
| Kartik Gupta    | Nitya Lal        |
| Kartik Gupta    | Abram Chokshi    |
| Pranay Khanna   | Romil Kapoor     |
</code></pre></div>
</div>
<h2>Existence and Correlated Subqueries</h2>
<div class="language-sql" title="correlated_subquery.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="correlated_subquery.out">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>Endocrinology is missing from the list</li>
<li><code>select 1</code> could equally be <code>select true</code> or any other value</li>
<li>A <a class="gl-ref" href="../glossary/#gl:correlated_subquery" markdown="1">correlated subquery</a> depends on a value from the outer query<ul>
<li>Equivalent to nested loop</li>
</ul>
</li>
</ul>
<h2>Nonexistence</h2>
<div class="language-sql" title="nonexistence.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="nonexistence.out">
<div class="highlight"><pre><span></span><code>|     name      | building |
|---------------|----------|
| Endocrinology | TGVH     |
</code></pre></div>
</div>
<h2 class="exercise">Exercise</h2>
<p>Can you rewrite the previous query using <code>exclude</code>?
If so, is your new query easier to understand?
If the query cannot be rewritten, why not?</p>
<h2 class="aside">Avoiding Correlated Subqueries</h2>
<div class="language-sql" title="avoid_correlated_subqueries.sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">building</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">staff</span><span class="p">.</span><span class="n">dept</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="avoid_correlated_subqueries.out">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>The join might or might not be faster than the correlated subquery</li>
<li>Hard to find unstaffed departments without either <code>not exists</code> or <code>count</code> and a check for 0</li>
</ul>
<h2>Lead and Lag</h2>
<div class="language-sql" title="lead_lag.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">lag</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_num</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="n">lead</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_num</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="lead_lag.out">
<div class="highlight"><pre><span></span><code>|   ym    | prev_num | num | next_num |
|---------|----------|-----|----------|
| 2023-01 |          | 2   | 5        |
| 2023-02 | 2        | 5   | 5        |
| 2023-03 | 5        | 5   | 1        |
| 2023-04 | 5        | 1   | 6        |
| 2023-05 | 1        | 6   | 5        |
| 2023-06 | 6        | 5   | 3        |
| 2023-07 | 5        | 3   | 2        |
| 2023-08 | 3        | 2   | 4        |
| 2023-09 | 2        | 4   | 6        |
| 2023-10 | 4        | 6   | 4        |
| 2023-12 | 6        | 4   | 5        |
| 2024-01 | 4        | 5   | 2        |
| 2024-02 | 5        | 2   |          |
</code></pre></div>
</div>
<ul>
<li>Use <code>strftime</code> to extract year and month<ul>
<li>Clumsy, but date/time handling is not SQLite&rsquo;s strong point</li>
</ul>
</li>
<li>Use <a class="gl-ref" href="../glossary/#gl:window_func" markdown="1">window functions</a> <code>lead</code> and <code>lag</code> to shift values<ul>
<li>Unavailable values at the top or bottom are null</li>
</ul>
</li>
</ul>
<h2 class="aside">Boundaries</h2>
<ul>
<li><a href="https://sqlite.org/windowfunctions.html">Documentation on SQLite&rsquo;s window functions</a> describes
    three frame types and five kinds of frame boundary</li>
<li>It feels very ad hoc, but so does the real world</li>
</ul>
<h2>Windowing Functions</h2>
<div class="language-sql" title="window_functions.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ym_num</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">completed_progress</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">linear_progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="window_functions.out">
<div class="highlight"><pre><span></span><code>|   ym    | num | num_done | completed_progress |  linear_progress   |
|---------|-----|----------|--------------------|--------------------|
| 2023-01 | 2   | 2        | 0.04               | 0.0769230769230769 |
| 2023-02 | 5   | 7        | 0.14               | 0.153846153846154  |
| 2023-03 | 5   | 12       | 0.24               | 0.230769230769231  |
| 2023-04 | 1   | 13       | 0.26               | 0.307692307692308  |
| 2023-05 | 6   | 19       | 0.38               | 0.384615384615385  |
| 2023-06 | 5   | 24       | 0.48               | 0.461538461538462  |
| 2023-07 | 3   | 27       | 0.54               | 0.538461538461538  |
| 2023-08 | 2   | 29       | 0.58               | 0.615384615384615  |
| 2023-09 | 4   | 33       | 0.66               | 0.692307692307692  |
| 2023-10 | 6   | 39       | 0.78               | 0.769230769230769  |
| 2023-12 | 4   | 43       | 0.86               | 0.846153846153846  |
| 2024-01 | 5   | 48       | 0.96               | 0.923076923076923  |
| 2024-02 | 2   | 50       | 1.0                | 1.0                |
</code></pre></div>
</div>
<ul>
<li><code>sum() over</code> does a running total</li>
<li><code>cume_dist()</code> is fraction <em>of rows seen so far</em></li>
<li>So <code>num_done</code> column is number of experiments doneâ€¦</li>
<li>â€¦<code>completed_progress</code> is the fraction of experiments doneâ€¦</li>
<li>â€¦and <code>linear_progress</code> is the fraction of time passed</li>
</ul>
<h2 class="aside">Explaining Another Query Plan</h2>
<div class="language-sql" title="explain_window_function.sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="explain_window_function.out">
<div class="highlight"><pre><span></span><code>QUERY PLAN
|--CO-ROUTINE (subquery-3)
|  |--CO-ROUTINE (subquery-4)
|  |  |--CO-ROUTINE ym_num
|  |  |  |--SCAN experiment
|  |  |  `--USE TEMP B-TREE FOR GROUP BY
|  |  |--SCAN ym_num
|  |  `--USE TEMP B-TREE FOR ORDER BY
|  `--SCAN (subquery-4)
`--SCAN (subquery-3)
</code></pre></div>
</div>
<ul>
<li>Becomes usefulâ€¦eventually</li>
</ul>
<h2>Partitioned Windows</h2>
<div class="language-sql" title="partition_window.sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">y_m_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">year</span><span class="p">,</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="k">year</span><span class="p">,</span>
<span class="w">    </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span>
<span class="k">from</span><span class="w"> </span><span class="n">y_m_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="language-out" title="partition_window.out">
<div class="highlight"><pre><span></span><code>| year | month | num | num_done |
|------|-------|-----|----------|
| 2023 | 01    | 2   | 2        |
| 2023 | 02    | 5   | 7        |
| 2023 | 03    | 5   | 12       |
| 2023 | 04    | 1   | 13       |
| 2023 | 05    | 6   | 19       |
| 2023 | 06    | 5   | 24       |
| 2023 | 07    | 3   | 27       |
| 2023 | 08    | 2   | 29       |
| 2023 | 09    | 4   | 33       |
| 2023 | 10    | 6   | 39       |
| 2023 | 12    | 4   | 43       |
| 2024 | 01    | 5   | 5        |
| 2024 | 02    | 2   | 7        |
</code></pre></div>
</div>
<ul>
<li><code>partition by</code> creates groups</li>
<li>So this counts experiments started since the beginning of each year</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Create a query that:</p>
<ol>
<li>
<p>finds the unique weights of the penguins in the <code>penguins</code> database;</p>
</li>
<li>
<p>sorts them;</p>
</li>
<li>
<p>finds the difference between each successive distinct weight; and</p>
</li>
<li>
<p>counts how many times each unique difference appears.</p>
</li>
</ol>
    </main>
    <footer>
  Â© 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sql-tutorial">repository</a>
  &middot;
  <a href="../license/">license</a>
</footer>

  </body>
</html>
