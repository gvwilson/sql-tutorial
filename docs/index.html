<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<script src="https://kit.fontawesome.com/4eee35f757.js"></script>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="github.css" type="text/css">
<link rel="stylesheet" href="tutorial.css" type="text/css">
<script defer data-domain="gvwilson.github.io/sql-tutorial" src="https://plausible.io/js/script.js"></script>
<title>The Querynomicon</title>

  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="#">Home</a>
    </div>
    <div class="col-10 right">
      <a href="https://github.com/gvwilson/sql-tutorial">repo</a>
      <a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">download</a>
      <a class="navlink" href="license/">license</a>
      <a class="navlink" href="conduct/">conduct</a>
      <a class="navlink" href="contributing/">contributing</a>
      <a class="navlink" href="colophon/">colophon</a>
    </div>
  </div>
</nav>

    <main>
      
  <h1>The Querynomicon</h1>
  <p class="subtitle">An Introduction to SQL for Wary Data Scientists</p>


      <div class="row">
  <div class="col-6 center">
    <img src="cthulhu-300x253.jpg" alt="stylized Cthulhu"/>
  </div>
  <div class="col-6">
    <p>
      <a href="https://github.com/gvwilson/sql-tutorial/issues/"><strong>The Querynomicon Needs Your Help</strong></a>
    </p>
    <ol>
      <li>
        <p><em>More exercises</em> to help learners practice.</p>
      </li>
      <li>
        <p><em>Sample solutions</em> so that they can check their work.</p>
      </li>
      <li>
        <p><em>CSS show/hide for solutions</em> because He Who Lies Dreaming said, "No JavaScript."</p>
      </li>
      <li>
        <p><em>Ideas for <a href="https://github.com/gvwilson/sys-tutorial/issues/1">the next tutorial</a></em> because why stop learning now?</p>
      </li>
    </ol>
  </div>
</div>

<blockquote>
<p>Upon first encountering SQL after two decades of Fortran, C, Java, and Python,
I thought I had stumbled into hell.
I quickly realized that was optimistic:
after all,
hell has rules.</p>
<p>I have since realized that SQL does too,
and that they are no more confusing or contradictory than those of most other programming languages.
They only appear so because it draws on a tradition unfamiliar to those of us raised with derivatives of C.
To quote <a href="https://terrypratchett.com/">the other bard</a>,
it is not mad, just differently sane.</p>
<p>Welcome, then, to a world in which the strange will become familiar, and the familiar, strange.
Welcome, thrice welcome, to SQL.</p>
</blockquote>
<!-- ---------------------------------------------------------------- -->
<section class="aside">
<h2 class="aside">What This Is</h2>
<ul>
<li>notes and working examples that instructors can use to perform a lesson<ul>
<li>do <em>not</em> expect novices with no prior SQL experience to be able to learn from them</li>
</ul>
</li>
<li>musical analogy<ul>
<li>this is the chord changes and melody</li>
<li>we expect instructors to create an arrangement and/or improvise while delivering</li>
<li>see <a href="https://teachtogether.tech/"><em>Teaching Tech Together</em></a> for background</li>
</ul>
</li>
<li>please see <a href="./license/">the license</a> for terms of use,
    the <a href="./conduct/">Code of Conduct</a> for community standards,
    and <a href="./contributing/">these guidelines</a> for notes on contributing</li>
<li>about the author:
    <a href="https://third-bit.com/">Greg Wilson</a> is a programmer, author, and educator based in Toronto</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Scope</h2>
<ul>
<li><a href="http://teachtogether.tech/en/index.html#s:process-personas">intended audience</a><ul>
<li>Rachel has a master&rsquo;s degree in cell biology
    and now works in a research hospital doing cell assays.</li>
<li>She learned a bit of R in an undergrad biostatistics course
    and has been through <a href="https://swcarpentry.github.io/shell-novice/">the Carpentries lesson on the Unix shell</a>.</li>
<li>Rachel is thinking about becoming a data scientist
    and would like to understand how data is stored and managed.</li>
<li>Her work schedule is unpredictable and highly variable,
    so she needs to be able to learn a bit at a time.</li>
</ul>
</li>
<li>prerequisites<ul>
<li>basic Unix command line: <code>cd</code>, <code>ls</code>, <code>*</code> wildcard</li>
<li>basic tabular data analysis: filtering rows, aggregating within groups</li>
</ul>
</li>
<li>learning outcomes<ol>
<li>Explain the difference between a database and a database manager.</li>
<li>Write SQL to select, filter, sort, group, and aggregate data.</li>
<li>Define tables and insert, update, and delete records.</li>
<li>Describe different types of join and write queries that use them to combine data.</li>
<li>Use windowing functions to operate on adjacent rows.</li>
<li>Explain what transactions are and write queries that roll back when constraints are violated.</li>
<li>Explain what triggers are and write SQL to create them.</li>
<li>Manipulate JSON data using SQL.</li>
<li>Interact with a database using Python directly, from a Jupyter notebook, and via an ORM.</li>
</ol>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Setup</h2>
<ul>
<li>Download <a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">the latest release</a></li>
<li>Unzip the file in a temporary directory to create:<ul>
<li><code>./db/*.db</code>: the <a href="https://sqlite.org/">SQLite</a> databases used in the examples</li>
<li><code>./src/*.*</code>: SQL queries, Python scripts, and other source code</li>
<li><code>./out/*.*</code>: expected output for examples</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Background Concepts</h2>
<ul>
<li>A <a href="#g:database">database</a> is a collection of data that can be searched and retrieved</li>
<li>A <a href="#g:dbms">database management system</a> (DBMS) is a program that manages a particular kind of database</li>
<li>Each DBMS stores data in its own way<ul>
<li>SQLite stores each database in a single file</li>
<li><a href="https://www.postgresql.org/">PostgreSQL</a> spreads information across many files for higher performance</li>
</ul>
</li>
<li>DBMS can be a library embedded in other programs (SQLite) or a server (PostgreSQL)</li>
<li>A <a href="#g:rdbms">relational database management system</a> (RDBMS) stores data in tables and uses <a href="https://en.wikipedia.org/wiki/SQL">SQL</a> for queries<ul>
<li>Unfortunately, every RDBMS has its own dialect of SQL</li>
</ul>
</li>
<li>There are also <a href="#g:nosql">NoSQL databases</a> like <a href="https://www.mongodb.com/">MongoDB</a> that don&rsquo;t use tables</li>
</ul>
<figure id="figure_1">
<img src="img/concept_map_overview.svg" alt="box and arrow concept map of major concepts related to databases"/>
<figcaption>Figure 1: overview of major concepts</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Connecting to Database</h2>
<p class="inclusion"><a href="src/connect_penguins.sh">src/connect_penguins.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>db/penguins.db
</code></pre></div>
</div>
<ul>
<li>Not actually a query: starts an interactive session</li>
<li>Alternative: provide a single query on the command line <code>sqlite3 <em>database</em> &ldquo;<em>query</em>&ldquo;</code></li>
<li>Or put query in file and run <code>sqlite3 <em>database</em> &lt; <em>filename</em></code></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">1: Selecting Constant</h2>
<p class="inclusion"><a href="src/select_1.sql">src/select_1.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/select_1.out">out/select_1.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>1
</code></pre></div>
</div>
<ul>
<li><code>select</code> is a keyword</li>
<li>Normally used to select data from table…</li>
<li>…but if all we want is a constant value, we don&rsquo;t need to specify one</li>
<li>Semi-colon terminator is required</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">2: Selecting All Values from Table</h2>
<p class="inclusion"><a href="src/select_star.sql">src/select_star.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/select_star.out">out/select_star.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Gentoo|Biscoe|51.3|14.2|218.0|5300.0|MALE
Adelie|Dream|35.7|18.0|202.0|3550.0|FEMALE
Adelie|Torgersen|36.6|17.8|185.0|3700.0|FEMALE
Chinstrap|Dream|55.8|19.8|207.0|4000.0|MALE
Adelie|Dream|38.1|18.6|190.0|3700.0|FEMALE
Adelie|Dream|36.2|17.3|187.0|3300.0|FEMALE
Adelie|Dream|39.5|17.8|188.0|3300.0|FEMALE
Gentoo|Biscoe|42.6|13.7|213.0|4950.0|FEMALE
Gentoo|Biscoe|52.1|17.0|230.0|5550.0|MALE
Adelie|Torgersen|36.7|18.8|187.0|3800.0|FEMALE
</code></pre></div>
</div>
<ul>
<li>An actual <a href="#g:query">query</a></li>
<li>Use <code>*</code> to mean &ldquo;all columns&rdquo;</li>
<li>Use <code>from <em>tablename</em></code> to specify table</li>
<li>Output format is not particularly readable</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Administrative Commands</h2>
<p class="inclusion"><a href="src/admin_commands.sql">src/admin_commands.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="k">on</span>
<span class="p">.</span><span class="k">mode</span><span class="w"> </span><span class="n">markdown</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/admin_commands.out">out/admin_commands.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |  island   | bill_length_mm | bill_depth_mm | flipper_length_mm | body_mass_g |  sex   |
|-----------|-----------|----------------|---------------|-------------------|-------------|--------|
| Gentoo    | Biscoe    | 51.3           | 14.2          | 218.0             | 5300.0      | MALE   |
| Adelie    | Dream     | 35.7           | 18.0          | 202.0             | 3550.0      | FEMALE |
| Adelie    | Torgersen | 36.6           | 17.8          | 185.0             | 3700.0      | FEMALE |
| Chinstrap | Dream     | 55.8           | 19.8          | 207.0             | 4000.0      | MALE   |
| Adelie    | Dream     | 38.1           | 18.6          | 190.0             | 3700.0      | FEMALE |
| Adelie    | Dream     | 36.2           | 17.3          | 187.0             | 3300.0      | FEMALE |
| Adelie    | Dream     | 39.5           | 17.8          | 188.0             | 3300.0      | FEMALE |
| Gentoo    | Biscoe    | 42.6           | 13.7          | 213.0             | 4950.0      | FEMALE |
| Gentoo    | Biscoe    | 52.1           | 17.0          | 230.0             | 5550.0      | MALE   |
| Adelie    | Torgersen | 36.7           | 18.8          | 187.0             | 3800.0      | FEMALE |
</code></pre></div>
</div>
<ul>
<li>SQLite administrative commands start with <code>.</code> and <em>aren&rsquo;t</em> part of the SQL standard<ul>
<li>PostgreSQL&rsquo;s special commands start with <code>\</code></li>
</ul>
</li>
<li>Use <code>.help</code> for a complete list</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">3: Specifying Columns</h2>
<p class="inclusion"><a href="src/specify_columns.sql">src/specify_columns.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span>
<span class="k">from</span><span class="w"> </span><span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/specify_columns.out">out/specify_columns.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |  island   |  sex   |
|-----------|-----------|--------|
| Gentoo    | Biscoe    | MALE   |
| Adelie    | Dream     | FEMALE |
| Adelie    | Torgersen | FEMALE |
| Chinstrap | Dream     | MALE   |
| Adelie    | Dream     | FEMALE |
| Adelie    | Dream     | FEMALE |
| Adelie    | Dream     | FEMALE |
| Gentoo    | Biscoe    | FEMALE |
| Gentoo    | Biscoe    | MALE   |
| Adelie    | Torgersen | FEMALE |
</code></pre></div>
</div>
<ul>
<li>Specify column names separated by commas<ul>
<li>In any order</li>
<li>Duplicates allowed</li>
</ul>
</li>
<li>Line breaks <strike>allowed</strike> encouraged for readability</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">4: Sorting</h2>
<p class="inclusion"><a href="src/sort.sql">src/sort.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">little_penguins</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="k">asc</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/sort.out">out/sort.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |  sex   |  island   |
|-----------|--------|-----------|
| Gentoo    | MALE   | Biscoe    |
| Gentoo    | MALE   | Biscoe    |
| Gentoo    | FEMALE | Biscoe    |
| Chinstrap | MALE   | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Torgersen |
| Adelie    | FEMALE | Torgersen |
</code></pre></div>
</div>
<ul>
<li><code>order by</code> must follow <code>from</code> (which must follow <code>select</code>)</li>
<li><code>asc</code> is ascending, <code>desc</code> is descending<ul>
<li>Default is ascending, but please specify</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 1</strong>:
Write a SQL query to select the sex and body mass columns from the <code>little_penguins</code> in that order,
sorted such that the largest body mass appears first.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">5: Limiting Output</h2>
<ul>
<li>Full dataset has 344 rows</li>
</ul>
<p class="inclusion"><a href="src/limit.sql">src/limit.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">island</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/limit.out">out/limit.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Dream     |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>
</div>
<ul>
<li>Comments start with <code>--</code> and run to the end of the line</li>
<li><code>limit <em>N</em></code> specifies maximum number of rows returned by query</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">6: Paging Output</h2>
<p class="inclusion"><a href="src/page.sql">src/page.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">island</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/page.out">out/page.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>
</div>
<ul>
<li><code>offset <em>N</em></code> must follow <code>limit</code></li>
<li>Specifies number of rows to skip from the start of the selection</li>
<li>So this query skips the first 3 and shows the next 10</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">7: Removing Duplicates</h2>
<p class="inclusion"><a href="src/distinct.sql">src/distinct.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/distinct.out">out/distinct.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |  sex   |  island   |
|-----------|--------|-----------|
| Adelie    | MALE   | Torgersen |
| Adelie    | FEMALE | Torgersen |
| Adelie    |        | Torgersen |
| Adelie    | FEMALE | Biscoe    |
| Adelie    | MALE   | Biscoe    |
| Adelie    | FEMALE | Dream     |
| Adelie    | MALE   | Dream     |
| Adelie    |        | Dream     |
| Chinstrap | FEMALE | Dream     |
| Chinstrap | MALE   | Dream     |
| Gentoo    | FEMALE | Biscoe    |
| Gentoo    | MALE   | Biscoe    |
| Gentoo    |        | Biscoe    |
</code></pre></div>
</div>
<ul>
<li><code>distinct</code> keyword must appear right after <code>select</code><ul>
<li>SQL was supposed to read like English</li>
</ul>
</li>
<li>Shows distinct combinations</li>
<li>Blanks in <code>sex</code> column show missing data<ul>
<li>We&rsquo;ll talk about this in a bit</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 2</strong>:
Write a SQL query to select the islands and species
from rows 50 to 60 inclusive of the <code>penguins</code> table.
Your result should have 11 rows.</p>
<p><strong>Exercise 3</strong>:
Modify your query to select distinct combinations of island and species
from the same rows
and compare the result to what you got in part 1.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">8: Filtering Results</h2>
<p class="inclusion"><a href="src/filter.sql">src/filter.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biscoe&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter.out">out/filter.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>
</div>
<ul>
<li><code>where <em>condition</em></code> <a href="#g:filter">filters</a> the rows produced by selection</li>
<li>Condition is evaluated independently for each row</li>
<li>Only rows that pass the test appear in results</li>
<li>Use single quotes for <code>'text data'</code> and double quotes for <code>"weird column names"</code><ul>
<li>SQLite will accept double-quoted text data but <a href="https://sqlfluff.com/">SQLFluff</a> will complain</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 4</strong>:
Write a query to select the body masses from <code>penguins</code> that are less than 3000.0 grams.</p>
<p><strong>Exercise 5</strong>:
Write another query to select the species and sex of penguins that weight less than 3000.0 grams.
This shows that the columns displayed and those used in filtering are independent of each other.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">9: Filtering with More Complex Conditions</h2>
<p class="inclusion"><a href="src/filter_and.sql">src/filter_and.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biscoe&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;MALE&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter_and.out">out/filter_and.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>
</div>
<ul>
<li><code>and</code>: both sub-conditions must be true</li>
<li><code>or</code>: either or both part must be true</li>
<li>Notice that the row for Gentoo penguins on Biscoe island with unknown (empty) sex didn&rsquo;t pass the test<ul>
<li>We&rsquo;ll talk about this in a bit</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 6</strong>:
Use the <code>not</code> operator to select penguins that are <em>not</em> Gentoos.</p>
<p><strong>Exercise 7</strong>:
SQL&rsquo;s <code>or</code> is an <a href="#g:inclusive_or">inclusive or</a>:
it succeeds if either <em>or both</em> conditions are true.
SQL does not provide a specific operator for <a href="#g:exclusive_or">exclusive or</a>,
which is true if either <em>but not both</em> conditions are true,
but the same effect can be achieved using <code>and</code>, <code>or</code>, and <code>not</code>.
Write a query to select penguins that are female <em>or</em> on Torgersen Island <em>but not both</em>.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">10: Doing Calculations</h2>
<p class="inclusion"><a href="src/calculations.sql">src/calculations.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">flipper_length_mm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/calculations.out">out/calculations.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| flipper_length_mm / 10.0 | body_mass_g / 1000.0 |
|--------------------------|----------------------|
| 18.1                     | 3.75                 |
| 18.6                     | 3.8                  |
| 19.5                     | 3.25                 |
</code></pre></div>
</div>
<ul>
<li>Can do the usual kinds of arithmetic on individual values<ul>
<li>Calculation done for each row independently</li>
</ul>
</li>
<li>Column name shows the calculation done</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">11: Renaming Columns</h2>
<p class="inclusion"><a href="src/rename_columns.sql">src/rename_columns.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">flipper_length_mm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flipper_cm</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">weight_kg</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">where_found</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/rename_columns.out">out/rename_columns.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
</code></pre></div>
</div>
<ul>
<li>Use <code><em>expression</em> as <em>name</em></code> to rename</li>
<li>Give result of calculation a meaningful name</li>
<li>Can also rename columns without modifying</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 8</strong>:
Write a single query that calculates and returns:</p>
<ol>
<li>A column called <code>what_where</code> that has the species and island of each penguin
    separated by a single space.</li>
<li>A column called <code>bill_ratio</code> that has the ratio of bill length to bill depth.</li>
</ol>
<p>You can use the <code>||</code> operator to concatenate text to solve part 1,
or look at <a href="https://sqlite.org/printf.html">the documentation for SQLite&rsquo;s <code>format()</code> function</a>.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_2">
<img src="img/concept_map_select.svg" alt="box and arrow diagram of concepts related to selection"/>
<figcaption>Figure 2: selection</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">12: Calculating with Missing Values</h2>
<p class="inclusion"><a href="src/show_missing_values.sql">src/show_missing_values.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">flipper_length_mm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flipper_cm</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">weight_kg</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">where_found</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/show_missing_values.out">out/show_missing_values.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
|            |           | Torgersen   |
| 19.3       | 3.45      | Torgersen   |
</code></pre></div>
</div>
<ul>
<li>SQL uses a special value <a href="#g:null"><code>null</code></a> to representing missing data<ul>
<li>Not 0 or empty string, but &ldquo;I don&rsquo;t know&rdquo;</li>
</ul>
</li>
<li>Flipper length and body weight not known for one of the first five penguins</li>
<li>&ldquo;I don&rsquo;t know&rdquo; divided by 10 or 1000 is &ldquo;I don&rsquo;t know&rdquo;</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 9</strong>:
Use SQLite&rsquo;s <code>.nullvalue</code> command
to change the printed representation of null to the string <code>null</code>
and then re-run the previous query.
When will displaying null as <code>null</code> be easier to understand?
When might it be misleading?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">13: Null Equality</h2>
<ul>
<li>Repeated from earlier (so it doesn&rsquo;t count against our query limit)</li>
</ul>
<p class="inclusion"><a href="src/filter.sql">src/filter.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biscoe&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter.out">out/filter.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>
</div>
<ul>
<li>If we ask for female penguins the row with the missing sex drops out</li>
</ul>
<p class="inclusion"><a href="src/null_equality.sql">src/null_equality.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biscoe&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;FEMALE&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/null_equality.out">out/null_equality.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">14: Null Inequality</h2>
<ul>
<li>But if we ask for penguins that <em>aren&rsquo;t</em> female it drops out as well</li>
</ul>
<p class="inclusion"><a href="src/null_inequality.sql">src/null_inequality.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biscoe&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;FEMALE&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/null_inequality.out">out/null_inequality.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species | sex  | island |
|---------|------|--------|
| Adelie  | MALE | Biscoe |
| Gentoo  | MALE | Biscoe |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">15: Ternary Logic</h2>
<p class="inclusion"><a href="src/ternary_logic.sql">src/ternary_logic.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/ternary_logic.out">out/ternary_logic.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| null = null |
|-------------|
|             |
</code></pre></div>
</div>
<ul>
<li>If we don&rsquo;t know the left and right values, we don&rsquo;t know if they&rsquo;re equal or not</li>
<li>So the result is <code>null</code></li>
<li>Get the same answer for <code>null != null</code></li>
<li><a href="#g:ternary_logic">Ternary logic</a></li>
</ul>
<table>
<tr>
    <th colspan="4">equality</th>
  </tr>
<tr>
    <th></th>
    <th>X</th>
    <th>Y</th>
    <th>null</th>
  </tr>
<tr>
    <th>X</th>
    <td>true</td>
    <td>false</td>
    <td>null</td>
  </tr>
<tr>
    <th>Y</th>
    <td>false</td>
    <td>true</td>
    <td>null</td>
  </tr>
<tr>
    <th>null</th>
    <td>null</td>
    <td>null</td>
    <td>null</td>
  </tr>
</table>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">16: Handling Null Safely</h2>
<p class="inclusion"><a href="src/safe_null_equality.sql">src/safe_null_equality.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/safe_null_equality.out">out/safe_null_equality.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species | sex |  island   |
|---------|-----|-----------|
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Dream     |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
</code></pre></div>
</div>
<ul>
<li>Use <code>is null</code> and <code>is not null</code> to handle null safely</li>
<li>Other parts of SQL handle nulls specially</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 10</strong>:
Write a query to find penguins whose body mass is known but whose sex is not.</p>
<p><strong>Exercise 11</strong>:
Write another query to find penguins whose sex is known but whose body mass is not.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_3">
<img src="img/concept_map_null.svg" alt="box and arrow diagram of concepts related to null values in SQL"/>
<figcaption>Figure 3: null</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">17: Aggregating</h2>
<p class="inclusion"><a href="src/simple_sum.sql">src/simple_sum.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_mass</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/simple_sum.out">out/simple_sum.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| total_mass |
|------------|
| 1437000.0  |
</code></pre></div>
</div>
<ul>
<li><a href="#g:aggregation">Aggregation</a> combines many values to produce one</li>
<li><code>sum</code> is an <a href="#g:aggregation_func">aggregation function</a></li>
<li>Combines corresponding values from multiple rows</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">18: Common Aggregation Functions</h2>
<p class="inclusion"><a href="src/common_aggregations.sql">src/common_aggregations.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">bill_length_mm</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">longest_bill</span><span class="p">,</span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="n">flipper_length_mm</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">shortest_flipper</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">bill_length_mm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">bill_depth_mm</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">weird_ratio</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/common_aggregations.out">out/common_aggregations.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| longest_bill | shortest_flipper |   weird_ratio    |
|--------------|------------------|------------------|
| 59.6         | 172.0            | 2.56087082530644 |
</code></pre></div>
</div>
<ul>
<li>This actually shouldn&rsquo;t work:
    can&rsquo;t calculate maximum or average if any values are null</li>
<li>SQL does the useful thing instead of the right one</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 12</strong>:
What is the average body mass of penguins that weight more than 3000.0 grams?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">19: Counting</h2>
<p class="inclusion"><a href="src/count_behavior.sql">src/count_behavior.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">count_star</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="n">sex</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">count_specific</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">sex</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">count_distinct</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/count_behavior.out">out/count_behavior.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| count_star | count_specific | count_distinct |
|------------|----------------|----------------|
| 344        | 333            | 2              |
</code></pre></div>
</div>
<ul>
<li><code>count(*)</code> counts rows</li>
<li><code>count(<em>column</em>)</code> counts non-null entries in column</li>
<li><code>count(distinct <em>column</em>)</code> counts distinct non-null entries</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 13</strong>:
How many different body masses are in the penguins dataset?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">20: Grouping</h2>
<p class="inclusion"><a href="src/simple_group.sql">src/simple_group.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/simple_group.out">out/simple_group.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  average_mass_g  |
|------------------|
| 4005.55555555556 |
| 3862.27272727273 |
| 4545.68452380952 |
</code></pre></div>
</div>
<ul>
<li>Put rows in <a href="#g:group">groups</a> based on distinct combinations of values in columns specified with <code>group by</code></li>
<li>Then perform aggregation separately for each group</li>
<li>But which is which?</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">21: Behavior of Unaggregated Columns</h2>
<p class="inclusion"><a href="src/unaggregated_columns.sql">src/unaggregated_columns.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/unaggregated_columns.out">out/unaggregated_columns.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  sex   |  average_mass_g  |
|--------|------------------|
|        | 4005.55555555556 |
| FEMALE | 3862.27272727273 |
| MALE   | 4545.68452380952 |
</code></pre></div>
</div>
<ul>
<li>All rows in each group have the same value for <code>sex</code>, so no need to aggregate</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">22: Arbitrary Choice in Aggregation</h2>
<p class="inclusion"><a href="src/arbitrary_in_aggregation.sql">src/arbitrary_in_aggregation.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w">                   </span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/arbitrary_in_aggregation.out">out/arbitrary_in_aggregation.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  sex   | body_mass_g |
|--------|-------------|
|        |             |
| FEMALE | 3800.0      |
| MALE   | 3750.0      |
</code></pre></div>
</div>
<ul>
<li>If we don&rsquo;t specify how to aggregate a column,
    SQLite chooses <em>any arbitrary value</em> from the group<ul>
<li>All penguins in each group have the same sex because we grouped by that, so we get the right answer</li>
<li>The body mass values are in the data but unpredictable</li>
<li>A common mistake</li>
</ul>
</li>
<li>Other database managers don&rsquo;t do this<ul>
<li>E.g., PostgreSQL complains that column must be used in an aggregation function</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 14</strong>:
Explain why the output of the previous query
has a blank line before the rows for female and male penguins.</p>
<p><strong>Exercise 15</strong>:
Write a query that shows each distinct body mass in the penguin dataset
and the number of penguins that weigh that much.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">23: Filtering Aggregated Values</h2>
<p class="inclusion"><a href="src/filter_aggregation.sql">src/filter_aggregation.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span>
<span class="k">having</span><span class="w"> </span><span class="n">average_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter_aggregation.out">out/filter_aggregation.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| sex  |  average_mass_g  |
|------|------------------|
|      | 4005.55555555556 |
| MALE | 4545.68452380952 |
</code></pre></div>
</div>
<ul>
<li>Using <code>having <em>condition</em></code> instead of <code>where <em>condition</em></code> for aggregates</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">24: Readable Output</h2>
<p class="inclusion"><a href="src/readable_aggregation.sql">src/readable_aggregation.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span>
<span class="k">having</span><span class="w"> </span><span class="n">average_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/readable_aggregation.out">out/readable_aggregation.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| sex  | average_mass_g |
|------|----------------|
|      | 4005.6         |
| MALE | 4545.7         |
</code></pre></div>
</div>
<ul>
<li>Use <code>round(<em>value</em>, <em>decimals</em>)</code> to round off a number</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">25: Filtering Aggregate Inputs</h2>
<p class="inclusion"><a href="src/filter_aggregate_inputs.sql">src/filter_aggregate_inputs.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">sex</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="k">where</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="mi">1</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sex</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter_aggregate_inputs.out">out/filter_aggregate_inputs.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  sex   | average_mass_g |
|--------|----------------|
|        | 3362.5         |
| FEMALE | 3417.3         |
| MALE   | 3729.6         |
</code></pre></div>
</div>
<ul>
<li><code>filter (where <em>condition</em>)</code> applies to <em>inputs</em></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 16</strong>:
Write a query that uses <code>filter</code> to calculate the average body masses
of heavy penguins (those over 4500 grams)
and light penguins (those under 3500 grams)
simultaneously.
Is it possible to do this using <code>where</code> instead of <code>filter</code>?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_4">
<img src="img/concept_map_aggregate.svg" alt="box and arrow diagram of concepts related to aggregation in SQL"/>
<figcaption>Figure 4: aggregation</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Creating In-memory Database</h2>
<p class="inclusion"><a href="src/in_memory_db.sh">src/in_memory_db.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>:memory:
</code></pre></div>
</div>
<ul>
<li>&ldquo;Connect&rdquo; to an <a href="#g:in_memory_db">in-memory database</a><ul>
<li>Changes aren&rsquo;t saved to disk</li>
<li>Very useful for testing (discussed later)</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">26: Creating Tables</h2>
<p class="inclusion"><a href="src/create_work_job.sql">src/create_work_job.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
</code></pre></div>
</div>
<ul>
<li><code>create table <em>name</em></code> followed by parenthesized list of columns</li>
<li>Each column is a name, a data type, and optional extra information<ul>
<li>E.g., <code>not null</code> prevents nulls from being added</li>
</ul>
</li>
<li><code>.schema</code> is <em>not</em> standard SQL</li>
<li>SQLite has added a few things<ul>
<li><code>create if not exists</code></li>
<li>upper-case keywords (SQL is case insensitive)</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">27: Inserting Data</h2>
<p class="inclusion"><a href="src/populate_work_job.sql">src/populate_work_job.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;mik&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;mik&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clean&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;mik&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;complain&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;po&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clean&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;po&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;complain&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;tay&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;complain&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/insert_values.out">out/insert_values.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |

| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tay    | complain  |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Following Along</h2>
<ul>
<li>To re-create this database:<ul>
<li><a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">Download the examples</a></li>
<li>Unzip that file</li>
<li><code>.read src/create_work_job.sql</code></li>
<li><code>.read src/populate_work_job.sql</code></li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 17</strong>:
Using an in-memory database,
define a table called <code>notes</code> with two text columns <code>author</code> and <code>note</code>
and then add three or four rows.
Use a query to check that the notes have been stored
and that you can (for example) select by author name.</p>
<p><strong>Exercise 18</strong>:
What happens if you try to insert too many or too few values into <code>notes</code>?
What happens if you insert a number instead of a string into the <code>note</code> field?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">28: Updating Rows</h2>
<p class="inclusion"><a href="src/update_work_job.sql">src/update_work_job.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">update</span><span class="w"> </span><span class="k">work</span>
<span class="k">set</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tae&#39;</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tay&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/update_rows.out">out/update_rows.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tae    | complain  |
</code></pre></div>
</div>
<ul>
<li>(Almost) always specify row(s) to update using <code>where</code><ul>
<li>Otherwise update all rows in table, which is usually not wanted</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">29: Deleting Rows</h2>
<p class="inclusion"><a href="src/delete_rows.sql">src/delete_rows.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tae&#39;</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/delete_rows.out">out/delete_rows.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
</code></pre></div>
</div>
<ul>
<li>Again, (almost) always specify row(s) to delete using <code>where</code></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 19</strong>:
What happens if you try to delete rows that don&rsquo;t exist
(e.g., all entries in <code>work</code> that refer to <code>juna</code>)?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">30: Backing Up</h2>
<p class="inclusion"><a href="src/backing_up.sql">src/backing_up.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">backup</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">person</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tae&#39;</span><span class="p">;</span>

<span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tae&#39;</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">backup</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/backing_up.out">out/backing_up.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |   job    |
|--------|----------|
| tae    | complain |
</code></pre></div>
</div>
<ul>
<li>We will explore another strategy based on <a href="#g:tombstone">tombstones</a> below</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 20</strong>:
Saving and restoring data as text:</p>
<ol>
<li>
<p>Re-create the <code>notes</code> table in an in-memory database
    and then use SQLite&rsquo;s <code>.output</code> and <code>.dump</code> commands
    to save the database to a file called <code>notes.sql</code>.
    Inspect the contents of this file:
    how has your data been stored?</p>
</li>
<li>
<p>Start a fresh SQLite session
    and load <code>notes.sql</code> using the <code>.read</code> command.
    Inspect the database using <code>.schema</code> and <code>select *</code>:
    is everything as you expected?</p>
</li>
</ol>
<p><strong>Exercise 21</strong>:
Saving and restoring data in binary format:</p>
<ol>
<li>
<p>Re-create the <code>notes</code> table in an in-memory database once again
    and use SQLite&rsquo;s <code>.backup</code> command to save it to a file called <code>notes.db</code>.
    Inspect this file using <code>od -c notes.db</code> or a text editor that can handle binary data:
    how has your data been stored?</p>
</li>
<li>
<p>Start a fresh SQLite session
    and load <code>notes.db</code> using the <code>.restore</code> command.
    Inspect the database using <code>.schema</code> and <code>select *</code>:
    is everything as you expected?</p>
</li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_5">
<img src="img/concept_map_datamod.svg" alt="box and arrow diagram of concepts relatd to defining and modifying data"/>
<figcaption>Figure 5: data definition and modification</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">31: Combining Information</h2>
<p class="inclusion"><a href="src/cross_join.sql">src/cross_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">cross</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/cross_join.out">out/cross_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | calibrate | clean     | 0.5      |
| mik    | clean     | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  | calibrate | 1.5      |
| mik    | complain  | clean     | 0.5      |
| po     | clean     | calibrate | 1.5      |
| po     | clean     | clean     | 0.5      |
| po     | complain  | calibrate | 1.5      |
| po     | complain  | clean     | 0.5      |
| tay    | complain  | calibrate | 1.5      |
| tay    | complain  | clean     | 0.5      |
</code></pre></div>
</div>
<ul>
<li>A <a href="#g:join">join</a> combines information from two tables</li>
<li><a href="#g:cross_join">cross join</a> constructs their cross product<ul>
<li>All combinations of rows from each</li>
</ul>
</li>
<li>Result isn&rsquo;t particularly useful: <code>job</code> and <code>name</code> values don&rsquo;t match<ul>
<li>I.e., the combined data has records whose parts have nothing to do with each other</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">32: Inner Join</h2>
<p class="inclusion"><a href="src/inner_join.sql">src/inner_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/inner_join.out">out/inner_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| po     | clean     | clean     | 0.5      |
</code></pre></div>
</div>
<ul>
<li>Use <code><em>table</em>.<em>column</em></code> notation to specify columns<ul>
<li>A column can have the same name as a table</li>
</ul>
</li>
<li>Use <code>on <em>condition</em></code> to specify <a href="#g:join_condition">join condition</a></li>
<li>Since <code>complain</code> doesn&rsquo;t appear in <code>job.name</code>, none of those rows are kept</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 22</strong>:
Re-run the query shown above using <code>where job = name</code> instead of the full <code>table.name</code> notation.
Is the shortened form easier or harder to read
and more or less likely to cause errors?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">33: Aggregating Joined Data</h2>
<p class="inclusion"><a href="src/aggregate_join.sql">src/aggregate_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pay</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/aggregate_join.out">out/aggregate_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
</code></pre></div>
</div>
<ul>
<li>Combines ideas we&rsquo;ve seen before</li>
<li>But Tay is missing from the table<ul>
<li>No records in the <code>job</code> table with <code>tay</code> as name</li>
<li>So no records to be grouped and summed</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">34: Left Join</h2>
<p class="inclusion"><a href="src/left_join.sql">src/left_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/left_join.out">out/left_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  |           |          |
| po     | clean     | clean     | 0.5      |
| po     | complain  |           |          |
| tay    | complain  |           |          |
</code></pre></div>
</div>
<ul>
<li>A <a href="#g:left_outer_join">left outer join</a> keeps all rows from the left table</li>
<li>Fills missing values from right table with null</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">35: Aggregating Left Joins</h2>
<p class="inclusion"><a href="src/aggregate_left_join.sql">src/aggregate_left_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pay</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/aggregate_left_join.out">out/aggregate_left_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    |     |
</code></pre></div>
</div>
<ul>
<li>That&rsquo;s better, but we&rsquo;d like to see 0 rather than a blank</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">36: Coalescing Values</h2>
<p class="inclusion"><a href="src/coalesce.sql">src/coalesce.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
<span class="w">    </span><span class="k">coalesce</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pay</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/coalesce.out">out/coalesce.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    | 0.0 |
</code></pre></div>
</div>
<ul>
<li><code>coalesce(<em>val1</em>, <em>val2</em>, …)</code> returns first non-null value</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Full Outer Join</h2>
<ul>
<li><a href="#g:full_outer_join">Full outer join</a> is the union of
    left outer join and <a href="#g:right_outer_join">right outer join</a></li>
<li>Almost the same as cross join, but consider:</li>
</ul>
<p class="inclusion"><a href="src/full_outer_join.sql">src/full_outer_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;light&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;heavy&#39;</span><span class="p">);</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">w</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/full_outer_join.out">out/full_outer_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   s   | w |
|-------|---|
| light |   |
| heavy |   |
</code></pre></div>
</div>
<ul>
<li>A cross join would produce empty result</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 23</strong>:
Find the least time each person spent on any job.
Your output should show that <code>mik</code> and <code>po</code> each spent 0.5 hours on some job.
Can you find a way to show the name of the job as well
using the SQL you have seen so far?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_6">
<img src="img/concept_map_join.svg" alt="box and arrow diagram of concepts related to joining tables"/>
<figcaption>Figure 6: join</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">37: Negating Incorrectly</h2>
<ul>
<li>Who doesn&rsquo;t calibrate?</li>
</ul>
<p class="inclusion"><a href="src/negate_incorrectly.sql">src/negate_incorrectly.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/negate_incorrectly.out">out/negate_incorrectly.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |
|--------|
| mik    |
| po     |
| tay    |
</code></pre></div>
</div>
<ul>
<li>But Mik <em>does</em> calibrate</li>
<li>Problem is that there&rsquo;s an entry for Mik cleaning</li>
<li>And since <code>'clean' != 'calibrate'</code>, that row is included in the results</li>
<li>We need a different approach…</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">38: Set Membership</h2>
<p class="inclusion"><a href="src/set_membership.sql">src/set_membership.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;mik&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tay&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/set_membership.out">out/set_membership.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |   job    |
|--------|----------|
| po     | clean    |
| po     | complain |
</code></pre></div>
</div>
<ul>
<li><code>in <em>values</em></code> and <code>not in <em>values</em></code> do exactly what you expect</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">39: Subqueries</h2>
<p class="inclusion"><a href="src/subquery_set.sql">src/subquery_set.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">person</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="k">work</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span>
<span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/subquery_set.out">out/subquery_set.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person |
|--------|
| po     |
| tay    |
</code></pre></div>
</div>
<ul>
<li>Use a <a href="#g:subquery">subquery</a> to select the people who <em>do</em> calibrate</li>
<li>Then select all the people who <em>aren&rsquo;t</em> in that set</li>
<li>Initially feels odd, but subqueries are useful in other ways</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Defining a Primary Key</h2>
<ul>
<li>Can use any field (or combination of fields) in a table as a <a href="#g:primary_key">primary key</a>
    as long as value(s) unique for each record</li>
<li>Uniquely identifies a particular record in a particular table</li>
</ul>
<p class="inclusion"><a href="src/primary_key.sql">src/primary_key.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">size</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">lab_equipment</span><span class="p">;</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lab_equipment</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/primary_key.out">out/primary_key.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| size | color | num |
|------|-------|-----|
| 1.5  | blue  | 2   |
| 1.5  | green | 1   |
| 2.5  | blue  | 1   |
Runtime error near line 17: UNIQUE constraint failed: lab_equipment.size, lab_equipment.color (19)
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 24</strong>:
Does the <code>penguins</code> table have a primary key?
If so, what is it?
What about the <code>work</code> and <code>job</code> tables?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">40: Autoincrementing and Primary Keys</h2>
<p class="inclusion"><a href="src/autoincrement.sql">src/autoincrement.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">ident</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">autoincrement</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mik&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;po&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tay&#39;</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prevented&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/autoincrement.out">out/autoincrement.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident | name |
|-------|------|
| 1     | mik  |
| 2     | po   |
| 3     | tay  |
Runtime error near line 12: UNIQUE constraint failed: person.ident (19)
</code></pre></div>
</div>
<ul>
<li>Database <a href="#g:autoincrement">autoincrements</a> <code>ident</code> each time a new record is added</li>
<li>Common to use that field as the primary key<ul>
<li>Unique for each record</li>
</ul>
</li>
<li>If Mik changes their name again,
    we only have to change one fact in the database</li>
<li>Downside: manual queries are harder to read (who is person 17?)</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Internal Tables</h2>
<p class="inclusion"><a href="src/sequence_table.sql">src/sequence_table.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sqlite_sequence</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/sequence_table.out">out/sequence_table.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  name  | seq |
|--------|-----|
| person | 3   |
</code></pre></div>
</div>
<ul>
<li>Sequence numbers are <em>not</em> reset when rows are deleted<ul>
<li>In part so that they can be used as primary keys</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 25</strong>:
Are you able to modify the values stored in <code>sqlite_sequence</code>?
In particular,
are you able to reset the values so that
the same sequence numbers are generated again?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">41: Altering Tables</h2>
<p class="inclusion"><a href="src/alter_tables.sql">src/alter_tables.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span>
<span class="k">add</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">job</span>
<span class="k">set</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;calibrate&#39;</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">job</span>
<span class="k">set</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;clean&#39;</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/alter_tables.out">out/alter_tables.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   name    | billable | ident |
|-----------|----------|-------|
| calibrate | 1.5      | 1     |
| clean     | 0.5      | 2     |
</code></pre></div>
</div>
<ul>
<li>Add a column after the fact</li>
<li>Since it can&rsquo;t be null, we have to provide a default value<ul>
<li>Really want to make it the primary key, but SQLite doesn&rsquo;t allow that after the fact</li>
</ul>
</li>
<li>Then use <code>update</code> to modify existing records<ul>
<li>Can modify any number of records at once</li>
<li>So be careful about <code>where</code> clause</li>
</ul>
</li>
<li>An example of <a href="#g:data_migration">data migration</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">M-to-N Relationships</h2>
<ul>
<li>Relationships between entities are usually characterized as:<ul>
<li><a href="#g:1_to_1">1-to-1</a>:
    fields in the same record</li>
<li><a href="#g:1_to_many">1-to-many</a>:
    the many have a <a href="#g:foreign_key">foreign key</a> referring to the one&rsquo;s primary key</li>
<li><a href="#g:many_to_many">many-to-many</a>:
    don&rsquo;t know how many keys to add to records (&ldquo;maximum&rdquo; never is)</li>
</ul>
</li>
<li>Nearly-universal solution is a <a href="#g:join_table">join table</a><ul>
<li>Each record is a pair of foreign keys</li>
<li>I.e., each record is the fact that records A and B are related</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">42: Creating New Tables from Old</h2>
<p class="inclusion"><a href="src/insert_select.sql">src/insert_select.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_work</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">job_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">person_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">(</span><span class="n">ident</span><span class="p">),</span>
<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">new_work</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">job_id</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">)</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="p">;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">new_work</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/insert_select.out">out/insert_select.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person_id | job_id |
|-----------|--------|
| 1         | 1      |
| 1         | 2      |
| 2         | 2      |
</code></pre></div>
</div>
<ul>
<li><code>new_work</code> is our join table</li>
<li>Each column refers to a record in some other table</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">43: Removing Tables</h2>
<p class="inclusion"><a href="src/drop_table.sql">src/drop_table.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">work</span><span class="p">;</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">new_work</span><span class="w"> </span><span class="k">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">work</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/drop_table.out">out/drop_table.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>CREATE TABLE job (
    ident integer primary key autoincrement,
    name text not null,
    billable real not null
);
CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person (
    ident integer primary key autoincrement,
    name text not null
);
CREATE TABLE IF NOT EXISTS &quot;work&quot; (
    person_id integer not null,
    job_id integer not null,
    foreign key(person_id) references person(ident),
    foreign key(job_id) references job(ident)
);
</code></pre></div>
</div>
<ul>
<li>Remove the old table and rename the new one to take its place<ul>
<li>Note <code>if exists</code></li>
</ul>
</li>
<li>Please back up your data first</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 26</strong>:
Reorganize the penguins database:</p>
<ol>
<li>
<p>Make a copy of the <code>penguins.db</code> file
    so that your changes won&rsquo;t affect the original.</p>
</li>
<li>
<p>Write a SQL script that reorganizes the data into three tables:
    one for each island.</p>
</li>
<li>
<p>Why is organizing data like this a bad idea?</p>
</li>
</ol>
<p><strong>Exercise 27</strong>:
Tools like <a href="https://sqitch.org/">Sqitch</a> can manage changes to database schemas and data
so that they can be saved in version control
and rolled back if they are unsuccessful.
Translate the changes made by the scripts above into Sqitch.
Note: this exercise may take an hour or more.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">44: Comparing Individual Values to Aggregates</h2>
<ul>
<li>Go back to the original penguins database</li>
</ul>
<p class="inclusion"><a href="src/compare_individual_aggregate.sql">src/compare_individual_aggregate.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">body_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/compare_individual_aggregate.out">out/compare_individual_aggregate.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| body_mass_g |
|-------------|
| 4675.0      |
| 4250.0      |
| 4400.0      |
| 4500.0      |
| 4650.0      |
</code></pre></div>
</div>
<ul>
<li>Get average body mass in subquery</li>
<li>Compare each row against that</li>
<li>Requires two scans of the data, but no way to avoid that<ul>
<li>Except calculating a running total each time a penguin is added to the table</li>
</ul>
</li>
<li>Null values aren&rsquo;t included in the average or in the final results</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 28</strong>:
Use a subquery to find the number of penguins
that weigh the same as the lightest penguin.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">45: Comparing Individual Values to Aggregates Within Groups</h2>
<p class="inclusion"><a href="src/compare_within_groups.sql">src/compare_within_groups.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">averaged</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">averaged</span><span class="p">.</span><span class="n">species</span>
<span class="k">where</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/compare_within_groups.out">out/compare_within_groups.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>
</div>
<ul>
<li>Subquery runs first to create temporary table <code>averaged</code> with average mass per species</li>
<li>Join that with <code>penguins</code></li>
<li>Filter to find penguins heavier than average within their species</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 29</strong>:
Use a subquery to find the number of penguins
that weigh the same as the lightest penguin of the same sex and species.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">46: Common Table Expressions</h2>
<p class="inclusion"><a href="src/common_table_expressions.sql">src/common_table_expressions.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">grouped</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_mass_g</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">grouped</span>
<span class="k">where</span><span class="w"> </span><span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/common_table_expressions.out">out/common_table_expressions.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>
</div>
<ul>
<li>Use <a href="#g:cte">common table expression</a> (CTE) to make queries clearer<ul>
<li>Nested subqueries quickly become difficult to understand</li>
</ul>
</li>
<li>Database decides how to optimize</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Explaining Query Plans</h2>
<p class="inclusion"><a href="src/explain_query_plan.sql">src/explain_query_plan.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/explain_query_plan.out">out/explain_query_plan.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>QUERY PLAN
|--SCAN penguins
`--USE TEMP B-TREE FOR GROUP BY
</code></pre></div>
</div>
<ul>
<li>SQLite plans to scan every row of the table</li>
<li>It will build a temporary <a href="#g:b_tree">B-tree data structure</a> to group rows</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 30</strong>:
Use a CTE to find
the number of penguins
that weigh the same as the lightest penguin of the same sex and species.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">47: Enumerating Rows</h2>
<ul>
<li>Every table has a special column called <code>rowid</code></li>
</ul>
<p class="inclusion"><a href="src/rowid.sql">src/rowid.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">rowid</span><span class="p">,</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/rowid.out">out/rowid.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| rowid | species |  island   |
|-------|---------|-----------|
| 1     | Adelie  | Torgersen |
| 2     | Adelie  | Torgersen |
| 3     | Adelie  | Torgersen |
| 4     | Adelie  | Torgersen |
| 5     | Adelie  | Torgersen |
</code></pre></div>
</div>
<ul>
<li><code>rowid</code> is persistent within a session<ul>
<li>I.e., if we delete the first 5 rows we now have row IDs 6…N</li>
</ul>
</li>
<li><em>Do not rely on row ID</em><ul>
<li>In particular, do not use it as a key</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 31</strong>:
To explore how row IDs behave:</p>
<ol>
<li>
<p>Suppose that you create a new table,
    add three rows,
    delete those rows,
    and add the same values again.
    Do you expect the row IDs of the final rows to be 1–3 or 4–6?</p>
</li>
<li>
<p>Using an in-memory database,
    perform the steps in part 1.
    Was the result what you expected?</p>
</li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">48: Conditionals</h2>
<p class="inclusion"><a href="src/if_else.sql">src/if_else.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="n">iif</span><span class="p">(</span>
<span class="w">            </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3500</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;large&#39;</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/if_else.out">out/if_else.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  | size  | num |
|-----------|-------|-----|
| Adelie    | small | 54  |
| Adelie    | large | 98  |
| Chinstrap | small | 17  |
| Chinstrap | large | 51  |
| Gentoo    | large | 124 |
</code></pre></div>
</div>
<ul>
<li><code>iif(<em>condition</em>, <em>true_result</em>, <em>false_result</em>)</code><ul>
<li>Note: <code>iif</code> with two i&rsquo;s</li>
</ul>
</li>
<li>May feel odd to think of <code>if</code>/<code>else</code> as a function,
    but common in <a href="#g:vectorization">vectorized</a> calculations</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 32</strong>:
What does each of the expressions shown below produce?
Which ones do you think actually attempt to divide by zero?</p>
<ol>
<li><code>iif(0, 123, 1/0)</code></li>
<li><code>iif(1, 123, 1/0)</code></li>
<li><code>iif(0, 1/0, 123)</code></li>
<li><code>iif(1, 1/0, 123)</code></li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">49: Selecting a Case</h2>
<ul>
<li>What if we want small, medium, and large?</li>
<li>Can nest <code>iif</code>, but quickly becomes unreadable</li>
</ul>
<p class="inclusion"><a href="src/case_when.sql">src/case_when.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">case</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3500</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;small&#39;</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;medium&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;large&#39;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/case_when.out">out/case_when.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |  size  | num |
|-----------|--------|-----|
| Adelie    | large  | 1   |
| Adelie    | small  | 54  |
| Adelie    | medium | 97  |
| Chinstrap | small  | 17  |
| Chinstrap | medium | 51  |
| Gentoo    | medium | 56  |
| Gentoo    | large  | 68  |
</code></pre></div>
</div>
<ul>
<li>Evaluate <code>when</code> options in order and take first</li>
<li>Result of <code>case</code> is null if no condition is true</li>
<li>Use <code>else</code> as fallback</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 33</strong>:
Modify the query above so that
the outputs are <code>"penguin is small"</code> and <code>"penguin is large"</code>
by concatenating the string <code>"penguin is "</code> to the entire <code>case</code>
rather than to the individual <code>when</code> branches.
(This exercise shows that <code>case</code>/<code>when</code> is an <a href="#g:expression">expression</a>
rather than a <a href="#g:statement">statement</a>.)</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">50: Checking a Range</h2>
<p class="inclusion"><a href="src/check_range.sql">src/check_range.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">sized_penguins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">species</span><span class="p">,</span>
<span class="w">        </span><span class="k">case</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">3500</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;abnormal&#39;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">size</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">sized_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="k">size</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/check_range.out">out/check_range.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  |   size   | num |
|-----------|----------|-----|
| Adelie    | abnormal | 55  |
| Adelie    | normal   | 97  |
| Chinstrap | abnormal | 17  |
| Chinstrap | normal   | 51  |
| Gentoo    | abnormal | 62  |
| Gentoo    | normal   | 62  |
</code></pre></div>
</div>
<ul>
<li><code>between</code> can make queries easier to read</li>
<li>But be careful of the <code>and</code> in the middle</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 34</strong>:
The expression <code>val between 'A' and 'Z'</code> is true if <code>val</code> is <code>'M'</code> (upper case)
but false if <code>val</code> is <code>'m'</code> (lower case).
Rewrite the expression using <a href="https://www.sqlite.org/lang_corefunc.html">SQLite&rsquo;s built-in scalar functions</a>
so that it is true in both cases.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>substr</code></td>
<td>Get substring given starting point and length</td>
</tr>
<tr>
<td><code>trim</code></td>
<td>Remove characters from beginning and end of string</td>
</tr>
<tr>
<td><code>ltrim</code></td>
<td>Remove characters from beginning of string</td>
</tr>
<tr>
<td><code>rtrim</code></td>
<td>Remove characters from end of string</td>
</tr>
<tr>
<td><code>length</code></td>
<td>Length of string</td>
</tr>
<tr>
<td><code>replace</code></td>
<td>Replace occurrences of substring with another string</td>
</tr>
<tr>
<td><code>upper</code></td>
<td>Return upper-case version of string</td>
</tr>
<tr>
<td><code>lower</code></td>
<td>Return lower-case version of string</td>
</tr>
<tr>
<td><code>instr</code></td>
<td>Find location of first occurrence of substring (returns 0 if not found)</td>
</tr>
</tbody>
</table>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Yet Another Database</h2>
<ul>
<li><a href="#g:er_diagram">Entity-relationship diagram</a> (ER diagram) shows relationships between tables</li>
<li>Like everything to do with databases, there are lots of variations</li>
</ul>
<figure id="figure_7">
<img src="img/assays_tables.svg" alt="table-level diagram of assay database showing primary and foreign key relationships"/>
<figcaption>Figure 7: assay database table diagram</figcaption>
</figure>
<figure id="figure_8">
<img src="img/assays_er.svg" alt="entity-relationship diagram showing logical structure of assay database"/>
<figcaption>Figure 8: assay ER diagram</figcaption>
</figure>
<p class="inclusion"><a href="src/assay_staff.sql">src/assay_staff.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/assay_staff.out">out/assay_staff.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident | personal |  family   | dept | age |
|-------|----------|-----------|------|-----|
| 1     | Kartik   | Gupta     |      | 46  |
| 2     | Divit    | Dhaliwal  | hist | 34  |
| 3     | Indrans  | Sridhar   | mb   | 47  |
| 4     | Pranay   | Khanna    | mb   | 51  |
| 5     | Riaan    | Dua       |      | 23  |
| 6     | Vedika   | Rout      | hist | 45  |
| 7     | Abram    | Chokshi   | gen  | 23  |
| 8     | Romil    | Kapoor    | hist | 38  |
| 9     | Ishaan   | Ramaswamy | mb   | 35  |
| 10    | Nitya    | Lal       | gen  | 52  |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 35</strong>:
Draw a table diagram and an ER diagram to represent the following database:</p>
<ul>
<li><code>person</code> has <code>id</code> and <code>full_name</code></li>
<li><code>course</code> has <code>id</code> and <code>name</code></li>
<li><code>section</code> has <code>course_id</code>, <code>start_date</code>, and <code>end_date</code></li>
<li><code>instructor</code> has <code>person_id</code> and <code>section_id</code></li>
<li><code>student</code> has <code>person_id</code>, <code>section_id</code>, and <code>status</code></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">51: Pattern Matching</h2>
<p class="inclusion"><a href="src/like_glob.sql">src/like_glob.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">personal</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%ya%&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/like_glob.out">out/like_glob.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| personal | family |
|----------|--------|
| Nitya    | Lal    |
</code></pre></div>
</div>
<ul>
<li><code>like</code> is the original SQL pattern matcher<ul>
<li><code>%</code> matches zero or more characters at the start or end of a string</li>
<li>Case insensitive by default</li>
</ul>
</li>
<li><code>glob</code> supports Unix-style wildcards</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 36</strong>:
Rewrite the pattern-matching query shown above using <code>glob</code>.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">52: Selecting First and Last Rows</h2>
<p class="inclusion"><a href="src/union_all.sql">src/union_all.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">asc</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/union_all.out">out/union_all.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident |    kind     |  started   |   ended    |
|-------|-------------|------------|------------|
| 17    | trial       | 2023-01-29 | 2023-01-30 |
| 35    | calibration | 2023-01-30 | 2023-01-30 |
| 36    | trial       | 2023-02-02 | 2023-02-03 |
| 25    | trial       | 2023-02-12 | 2023-02-14 |
| 2     | calibration | 2023-02-14 | 2023-02-14 |
| 40    | calibration | 2024-01-21 | 2024-01-21 |
| 12    | trial       | 2024-01-26 | 2024-01-28 |
| 44    | trial       | 2024-01-27 | 2024-01-29 |
| 34    | trial       | 2024-02-01 | 2024-02-02 |
| 14    | calibration | 2024-02-03 | 2024-02-03 |
</code></pre></div>
</div>
<ul>
<li><code>union all</code> combines records<ul>
<li>Keeps duplicates: <code>union</code> on its own only keeps unique records</li>
<li>Which is more work but sometimes more useful</li>
</ul>
</li>
<li>Yes, it feels like the extra <code>select * from</code> should be unnecessary</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 37</strong>:
Write a query whose result includes two rows for each Adelie penguin
in the <code>penguins</code> database.
How can you check that your query is working correctly?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">53: Intersection</h2>
<p class="inclusion"><a href="src/intersect.sql">src/intersect.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">intersect</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/intersect.out">out/intersect.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| personal |  family   | dept | age |
|----------|-----------|------|-----|
| Indrans  | Sridhar   | mb   | 47  |
| Ishaan   | Ramaswamy | mb   | 35  |
</code></pre></div>
</div>
<ul>
<li>Rows involved must have the same structure</li>
<li>Intersection usually used when pulling values from different sources<ul>
<li>In the query above, would be clearer to use <code>where</code></li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 38</strong>:
Use <code>intersect</code> to find all Adelie penguins that weigh more than 4000 grams.
How can you check that your query is working correctly?</p>
<p><strong>Exercise 39</strong>:
Use <code>explain query plan</code> to compare the <code>intersect</code>-based query you just wrote
with one that uses <code>where</code>.
Which query looks like it will be more efficient?
Why do you believe this?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">54: Exclusion</h2>
<p class="inclusion"><a href="src/except.sql">src/except.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">personal</span><span class="p">,</span>
<span class="w">    </span><span class="n">family</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept</span><span class="p">,</span>
<span class="w">    </span><span class="n">age</span>
<span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mb&#39;</span>
<span class="k">except</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">personal</span><span class="p">,</span>
<span class="w">        </span><span class="n">family</span><span class="p">,</span>
<span class="w">        </span><span class="n">dept</span><span class="p">,</span>
<span class="w">        </span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/except.out">out/except.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| personal | family | dept | age |
|----------|--------|------|-----|
| Pranay   | Khanna | mb   | 51  |
</code></pre></div>
</div>
<ul>
<li>Again, tables must have same structure<ul>
<li>And this would be clearer with <code>where</code></li>
</ul>
</li>
<li>SQL operates on sets, not tables, except where it doesn&rsquo;t</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 40</strong>:
Use <code>exclude</code> to find all Gentoo penguins that <em>aren&rsquo;t</em> male.
How can you check that your query is working correctly?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">55: Random Numbers and Why Not</h2>
<p class="inclusion"><a href="src/random_numbers.sql">src/random_numbers.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">decorated</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">rand</span><span class="p">,</span>
<span class="w">    </span><span class="k">abs</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">selector</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">decorated</span>
<span class="k">where</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/random_numbers.out">out/random_numbers.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|         rand         | selector |      name      |
|----------------------|----------|----------------|
| 1175447513360584797  | 6        | Divit Dhaliwal |
| -1544776661445066577 | 5        | Pranay Khanna  |
| -9091755230464281578 | 1        | Riaan Dua      |
| -3436533101074958267 | 6        | Romil Kapoor   |
| -1361395956632904964 | 7        | Nitya Lal      |
</code></pre></div>
</div>
<ul>
<li>There is no way to seed SQLite&rsquo;s random number generator</li>
<li>Which means there is no way to reproduce its pseudo-random sequences</li>
<li>Which means you should <em>never</em> use it<ul>
<li>How are you going to debug something you can&rsquo;t re-run?</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 41</strong>:
Write a query that:</p>
<ul>
<li>
<p>uses a CTE to create 1000 random numbers between 0 and 10 inclusive;</p>
</li>
<li>
<p>uses a second CTE to calculate their mean; and</p>
</li>
<li>
<p>uses a third CTE and <a href="https://www.sqlite.org/lang_mathfunc.html">SQLite&rsquo;s built-in math functions</a>
    to calculate their standard deviation.</p>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">56: Creating an Index</h2>
<p class="inclusion"><a href="src/create_use_index.sql">src/create_use_index.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">plate_file</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">plate</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

<span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">select</span><span class="w"> </span><span class="n">filename</span>
<span class="k">from</span><span class="w"> </span><span class="n">plate</span>
<span class="k">where</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%07%&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/create_use_index.out">out/create_use_index.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>QUERY PLAN
`--SCAN plate USING COVERING INDEX sqlite_autoindex_plate_1
QUERY PLAN
`--SCAN plate USING COVERING INDEX plate_file
</code></pre></div>
</div>
<ul>
<li>An <a href="#g:index">index</a> is an auxiliary data structure that enables faster access to records<ul>
<li>Spend storage space to buy speed</li>
</ul>
</li>
<li>Don&rsquo;t have to mention it explicitly in queries<ul>
<li>Database manager will use it automatically</li>
</ul>
</li>
<li>Unlike primary keys, SQLite supports defining indexes after the fact</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">57: Generating Sequences</h2>
<p class="inclusion"><a href="src/generate_sequence.sql">src/generate_sequence.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/generate_sequence.out">out/generate_sequence.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>A (non-standard) <a href="#g:table_valued_func">table-valued function</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">58: Generating Sequences Based on Data</h2>
<p class="inclusion"><a href="src/data_range_sequence.sql">src/data_range_sequence.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/data_range_sequence.out">out/data_range_sequence.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>
</div>
<ul>
<li>Must have the parentheses around the <code>min</code> and <code>max</code> selections to keep SQLite happy</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">59: Generating Sequences of Dates</h2>
<p class="inclusion"><a href="src/date_sequence.sql">src/date_sequence.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/date_sequence.out">out/date_sequence.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  some_day  |
|------------|
| 2023-01-29 |
| 2023-01-30 |
| 2023-01-31 |
| 2023-02-01 |
| 2023-02-02 |
</code></pre></div>
</div>
<ul>
<li>SQLite represents dates as YYYY-MM-DD strings
    or as Julian days or as Unix milliseconds or…<ul>
<li>Julian days is fractional number of days since November 24, 4714 BCE</li>
</ul>
</li>
<li><code>julianday</code> and <code>date</code> convert back and forth</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">60: Counting Experiments Started per Day Without Gaps</h2>
<p class="inclusion"><a href="src/experiments_per_day.sql">src/experiments_per_day.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="c1">-- complete sequence of days with 0 as placeholder for number of experiments</span>
<span class="n">all_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="nb">date</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">some_day</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zeroes</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">),</span>

<span class="c1">-- sequence of actual days with actual number of experiments started</span>
<span class="n">actual_days</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">started</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">started</span>
<span class="p">)</span>

<span class="c1">-- combined by joining on day and taking actual number (if available) or zero</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">day</span><span class="p">,</span>
<span class="w">    </span><span class="k">coalesce</span><span class="p">(</span><span class="n">actual_days</span><span class="p">.</span><span class="n">num_exp</span><span class="p">,</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">zeroes</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_exp</span>
<span class="k">from</span>
<span class="w">    </span><span class="n">all_days</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">actual_days</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual_days</span><span class="p">.</span><span class="n">started</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/experiments_per_day.out">out/experiments_per_day.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|    day     | num_exp |
|------------|---------|
| 2023-01-29 | 1       |
| 2023-01-30 | 1       |
| 2023-01-31 | 0       |
| 2023-02-01 | 0       |
| 2023-02-02 | 1       |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 42</strong>:
What does the expression <code>date('now', 'start of month', '+1 month', '-1 day')</code> produce?
(You may find <a href="https://www.sqlite.org/lang_datefunc.html">the documentation on SQLite&rsquo;s date and time functions</a> helpful.)</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">61: Self Join</h2>
<p class="inclusion"><a href="src/self_join.sql">src/self_join.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/self_join.out">out/self_join.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|     name     |       name       |
|--------------|------------------|
| Kartik Gupta | Kartik Gupta     |
| Kartik Gupta | Divit Dhaliwal   |
| Kartik Gupta | Indrans Sridhar  |
| Kartik Gupta | Pranay Khanna    |
| Kartik Gupta | Riaan Dua        |
| Kartik Gupta | Vedika Rout      |
| Kartik Gupta | Abram Chokshi    |
| Kartik Gupta | Romil Kapoor     |
| Kartik Gupta | Ishaan Ramaswamy |
| Kartik Gupta | Nitya Lal        |
</code></pre></div>
</div>
<ul>
<li>Join a table to itself<ul>
<li>Use <code>as</code> to create <a href="#g:alias">aliases</a> for copies of tables to distinguish them</li>
<li>Nothing special about the names <code>left</code> and <code>right</code></li>
</ul>
</li>
<li>Get all <math>n<sup>2</sup></math> pairs, including person with themself</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">62: Generating Unique Pairs</h2>
<p class="inclusion"><a href="src/unique_pairs.sql">src/unique_pairs.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span>
<span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span>
<span class="k">where</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/unique_pairs.out">out/unique_pairs.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|      name       |      name       |
|-----------------|-----------------|
| Kartik Gupta    | Divit Dhaliwal  |
| Kartik Gupta    | Indrans Sridhar |
| Kartik Gupta    | Pranay Khanna   |
| Divit Dhaliwal  | Indrans Sridhar |
| Divit Dhaliwal  | Pranay Khanna   |
| Indrans Sridhar | Pranay Khanna   |
</code></pre></div>
</div>
<ul>
<li><code>left.ident &lt; right.ident</code> ensures distinct pairs without duplicates<ul>
<li>Query uses <code>left.ident &lt;= 4 and right.ident &lt;= 4</code> to shorten output</li>
</ul>
</li>
<li>Quick check: <math>n(n-1)/2</math> pairs</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">63: Filtering Pairs</h2>
<p class="inclusion"><a href="src/filter_pairs.sql">src/filter_pairs.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span>
<span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">ident</span><span class="p">,</span>
<span class="w">        </span><span class="n">personal</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="p">),</span>

<span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">left_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_staff</span><span class="p">,</span>
<span class="w">        </span><span class="n">right_perf</span><span class="p">.</span><span class="n">staff</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_staff</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_perf</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_perf</span>
<span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="n">left_perf</span><span class="p">.</span><span class="n">experiment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_perf</span><span class="p">.</span><span class="n">experiment</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right_staff</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_1</span><span class="p">,</span>
<span class="w">    </span><span class="n">right_person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person_2</span>
<span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_person</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_person</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">together</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">left_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left_staff</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">right_person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right_staff</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/filter_pairs.out">out/filter_pairs.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|    person_1     |     person_2     |
|-----------------|------------------|
| Kartik Gupta    | Vedika Rout      |
| Pranay Khanna   | Vedika Rout      |
| Indrans Sridhar | Romil Kapoor     |
| Abram Chokshi   | Ishaan Ramaswamy |
| Pranay Khanna   | Vedika Rout      |
| Kartik Gupta    | Abram Chokshi    |
| Abram Chokshi   | Romil Kapoor     |
| Kartik Gupta    | Divit Dhaliwal   |
| Divit Dhaliwal  | Abram Chokshi    |
| Pranay Khanna   | Ishaan Ramaswamy |
| Indrans Sridhar | Romil Kapoor     |
| Kartik Gupta    | Ishaan Ramaswamy |
| Kartik Gupta    | Nitya Lal        |
| Kartik Gupta    | Abram Chokshi    |
| Pranay Khanna   | Romil Kapoor     |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">64: Existence and Correlated Subqueries</h2>
<p class="inclusion"><a href="src/correlated_subquery.sql">src/correlated_subquery.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/correlated_subquery.out">out/correlated_subquery.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>Endocrinology is missing from the list</li>
<li><code>select 1</code> could equally be <code>select true</code> or any other value</li>
<li>A <a href="#g:correlated_subquery">correlated subquery</a> depends on a value from the outer query<ul>
<li>Equivalent to nested loop</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">65: Nonexistence</h2>
<p class="inclusion"><a href="src/nonexistence.sql">src/nonexistence.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="k">where</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">staff</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/nonexistence.out">out/nonexistence.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|     name      | building |
|---------------|----------|
| Endocrinology | TGVH     |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 43</strong>:
Can you rewrite the previous query using <code>exclude</code>?
If so, is your new query easier to understand?
If the query cannot be rewritten, why not?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Avoiding Correlated Subqueries</h2>
<p class="inclusion"><a href="src/avoid_correlated_subqueries.sql">src/avoid_correlated_subqueries.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">department</span><span class="p">.</span><span class="n">building</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">building</span>
<span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">staff</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">staff</span><span class="p">.</span><span class="n">dept</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/avoid_correlated_subqueries.out">out/avoid_correlated_subqueries.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>
</div>
<ul>
<li>The join might or might not be faster than the correlated subquery</li>
<li>Hard to find unstaffed departments without either <code>not exists</code> or <code>count</code> and a check for 0</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">66: Lead and Lag</h2>
<p class="inclusion"><a href="src/lead_lag.sql">src/lead_lag.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">lag</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prev_num</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="n">lead</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">next_num</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/lead_lag.out">out/lead_lag.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   ym    | prev_num | num | next_num |
|---------|----------|-----|----------|
| 2023-01 |          | 2   | 5        |
| 2023-02 | 2        | 5   | 5        |
| 2023-03 | 5        | 5   | 1        |
| 2023-04 | 5        | 1   | 6        |
| 2023-05 | 1        | 6   | 5        |
| 2023-06 | 6        | 5   | 3        |
| 2023-07 | 5        | 3   | 2        |
| 2023-08 | 3        | 2   | 4        |
| 2023-09 | 2        | 4   | 6        |
| 2023-10 | 4        | 6   | 4        |
| 2023-12 | 6        | 4   | 5        |
| 2024-01 | 4        | 5   | 2        |
| 2024-02 | 5        | 2   |          |
</code></pre></div>
</div>
<ul>
<li>Use <code>strftime</code> to extract year and month<ul>
<li>Clumsy, but date/time handling is not SQLite&rsquo;s strong point</li>
</ul>
</li>
<li>Use <a href="#g:window_func">window functions</a> <code>lead</code> and <code>lag</code> to shift values<ul>
<li>Unavailable values at the top or bottom are null</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Boundaries</h2>
<ul>
<li><a href="https://sqlite.org/windowfunctions.html">Documentation on SQLite&rsquo;s window functions</a> describes
    three frame types and five kinds of frame boundary</li>
<li>It feels very ad hoc, but so does the real world</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">67: Windowing Functions</h2>
<p class="inclusion"><a href="src/window_functions.sql">src/window_functions.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/window_functions.out">out/window_functions.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   ym    | num | num_done |      progress      |
|---------|-----|----------|--------------------|
| 2023-01 | 2   | 2        | 0.0769230769230769 |
| 2023-02 | 5   | 7        | 0.153846153846154  |
| 2023-03 | 5   | 12       | 0.230769230769231  |
| 2023-04 | 1   | 13       | 0.307692307692308  |
| 2023-05 | 6   | 19       | 0.384615384615385  |
| 2023-06 | 5   | 24       | 0.461538461538462  |
| 2023-07 | 3   | 27       | 0.538461538461538  |
| 2023-08 | 2   | 29       | 0.615384615384615  |
| 2023-09 | 4   | 33       | 0.692307692307692  |
| 2023-10 | 6   | 39       | 0.769230769230769  |
| 2023-12 | 4   | 43       | 0.846153846153846  |
| 2024-01 | 5   | 48       | 0.923076923076923  |
| 2024-02 | 2   | 50       | 1.0                |
</code></pre></div>
</div>
<ul>
<li><code>sum() over</code> does a running total</li>
<li><code>cume_dist</code> is fraction <em>of rows seen so far</em></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Explaining Another Query Plan</h2>
<p class="inclusion"><a href="src/explain_window_function.sql">src/explain_window_function.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">explain</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">plan</span>
<span class="k">with</span><span class="w"> </span><span class="n">ym_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ym</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">ym</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span><span class="p">,</span>
<span class="w">    </span><span class="n">cume_dist</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">progress</span>
<span class="k">from</span><span class="w"> </span><span class="n">ym_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ym</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/explain_window_function.out">out/explain_window_function.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>QUERY PLAN
|--CO-ROUTINE (subquery-3)
|  |--CO-ROUTINE (subquery-4)
|  |  |--CO-ROUTINE ym_num
|  |  |  |--SCAN experiment
|  |  |  `--USE TEMP B-TREE FOR GROUP BY
|  |  |--SCAN ym_num
|  |  `--USE TEMP B-TREE FOR ORDER BY
|  `--SCAN (subquery-4)
`--SCAN (subquery-3)
</code></pre></div>
</div>
<ul>
<li>Becomes useful…eventually</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">68: Partitioned Windows</h2>
<p class="inclusion"><a href="src/partition_window.sql">src/partition_window.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">y_m_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">year</span><span class="p">,</span>
<span class="w">        </span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">experiment</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="k">year</span><span class="p">,</span>
<span class="w">    </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">month</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_done</span>
<span class="k">from</span><span class="w"> </span><span class="n">y_m_num</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/partition_window.out">out/partition_window.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| year | month | num | num_done |
|------|-------|-----|----------|
| 2023 | 01    | 2   | 2        |
| 2023 | 02    | 5   | 7        |
| 2023 | 03    | 5   | 12       |
| 2023 | 04    | 1   | 13       |
| 2023 | 05    | 6   | 19       |
| 2023 | 06    | 5   | 24       |
| 2023 | 07    | 3   | 27       |
| 2023 | 08    | 2   | 29       |
| 2023 | 09    | 4   | 33       |
| 2023 | 10    | 6   | 39       |
| 2023 | 12    | 4   | 43       |
| 2024 | 01    | 5   | 5        |
| 2024 | 02    | 2   | 7        |
</code></pre></div>
</div>
<ul>
<li><code>partition by</code> creates groups</li>
<li>So this counts experiments started since the beginning of each year</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 44</strong>:
Create a query that:</p>
<ol>
<li>
<p>finds the unique weights of the penguins in the <code>penguins</code> database;</p>
</li>
<li>
<p>sorts them;</p>
</li>
<li>
<p>finds the difference between each successive distinct weight; and</p>
</li>
<li>
<p>counts how many times each unique difference appears.</p>
</li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">69: Blobs</h2>
<p class="inclusion"><a href="src/blob.sql">src/blob.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="nb">blob</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;biohazard&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">readfile</span><span class="p">(</span><span class="s1">&#39;res/img/biohazard.png&#39;</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">&#39;crush&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">readfile</span><span class="p">(</span><span class="s1">&#39;res/img/crush.png&#39;</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">&#39;fire&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">readfile</span><span class="p">(</span><span class="s1">&#39;res/img/fire.png&#39;</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">&#39;radioactive&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">readfile</span><span class="p">(</span><span class="s1">&#39;res/img/radioactive.png&#39;</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">&#39;tripping&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">readfile</span><span class="p">(</span><span class="s1">&#39;res/img/tripping.png&#39;</span><span class="p">));</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">length</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">images</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/blob.out">out/blob.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|    name     | length(content) |
|-------------|-----------------|
| biohazard   | 19629           |
| crush       | 15967           |
| fire        | 18699           |
| radioactive | 16661           |
| tripping    | 17208           |
</code></pre></div>
</div>
<ul>
<li>A <a href="#g:blob">blob</a> is a binary large object<ul>
<li>Bytes in, bytes out…</li>
</ul>
</li>
<li>If you think that&rsquo;s odd, check out <a href="https://fossil-scm.org/">Fossil</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 45</strong>:
Modify the query shown above to select the value of <code>content</code>
rather than its length.
How intelligible is the output?
Does using SQLite&rsquo;s <code>hex()</code> function make it any more readable?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Yet Another Database</h2>
<p class="inclusion"><a href="src/lab_log_db.sh">src/lab_log_db.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>data/lab_log.db
</code></pre></div>
</div>
<p class="inclusion"><a href="src/lab_log_schema.sql">src/lab_log_schema.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="k">schema</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/lab_log_schema.out">out/lab_log_schema.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person(
       ident            integer primary key autoincrement,
       details          text not null
);
CREATE TABLE machine(
       ident            integer primary key autoincrement,
       name             text not null,
       details          text not null
);
CREATE TABLE usage(
       ident            integer primary key autoincrement,
       log              text not null
);
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">70: Storing JSON</h2>
<p class="inclusion"><a href="src/json_in_table.sql">src/json_in_table.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">machine</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_in_table.out">out/json_in_table.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident |      name      |                         details                         |
|-------|----------------|---------------------------------------------------------|
| 1     | WY401          | {&quot;acquired&quot;: &quot;2023-05-01&quot;}                              |
| 2     | Inphormex      | {&quot;acquired&quot;: &quot;2021-07-15&quot;, &quot;refurbished&quot;: &quot;2023-10-22&quot;} |
| 3     | AutoPlate 9000 | {&quot;note&quot;: &quot;needs software update&quot;}                       |
</code></pre></div>
</div>
<ul>
<li>Store heterogeneous data as <a href="#g:json">JSON</a>-formatted text
    (with double-quoted strings)<ul>
<li>Database parses the text each time it is queried,
    so performance can be an issue</li>
</ul>
</li>
<li>Can alternatively store as blob (<code>jsonb</code>)<ul>
<li>Can&rsquo;t view it directly</li>
<li>But more efficient</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">71: Select Fields from JSON</h2>
<p class="inclusion"><a href="src/json_field.sql">src/json_field.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">details</span><span class="o">-&gt;</span><span class="s1">&#39;$.acquired&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">single_arrow</span><span class="p">,</span>
<span class="w">    </span><span class="n">details</span><span class="o">-&gt;&gt;</span><span class="s1">&#39;$.acquired&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">double_arrow</span>
<span class="k">from</span><span class="w"> </span><span class="n">machine</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_field.out">out/json_field.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| single_arrow | double_arrow |
|--------------|--------------|
| &quot;2023-05-01&quot; | 2023-05-01   |
| &quot;2021-07-15&quot; | 2021-07-15   |
|              |              |
</code></pre></div>
</div>
<ul>
<li>Single arrow <code>-&gt;</code> returns JSON representation of result</li>
<li>Double arrow <code>-&gt;&gt;</code> returns SQL text, integer, real, or null</li>
<li>Left side is column</li>
<li>Right side is <a href="#g:path_expression">path expression</a><ul>
<li>Start with <code>$</code> (meaning &ldquo;root&rdquo;)</li>
<li>Fields separated by <code>.</code></li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 46</strong>:
Write a query that selects the year from the <code>"refurbished"</code> field
of the JSON data associated with the Inphormex plate reader.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">72: JSON Array Access</h2>
<p class="inclusion"><a href="src/json_array.sql">src/json_array.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">ident</span><span class="p">,</span>
<span class="w">    </span><span class="n">json_array_length</span><span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="s1">&#39;$&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">length</span><span class="p">,</span>
<span class="w">    </span><span class="n">log</span><span class="o">-&gt;</span><span class="s1">&#39;$[0]&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">first</span>
<span class="k">from</span><span class="w"> </span><span class="k">usage</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_array.out">out/json_array.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident | length |                            first                             |
|-------|--------|--------------------------------------------------------------|
| 1     | 4      | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Gabrielle&quot;,&quot;Dub\u00e9&quot;]}   |
| 2     | 5      | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}       |
| 3     | 2      | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Josette&quot;,&quot;Villeneuve&quot;]}   |
| 4     | 1      | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Maude&quot;,&quot;Goulet&quot;]}         |
| 5     | 2      | {&quot;machine&quot;:&quot;AutoPlate 9000&quot;,&quot;person&quot;:[&quot;Brigitte&quot;,&quot;Michaud&quot;]} |
| 6     | 1      | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}      |
| 7     | 3      | {&quot;machine&quot;:&quot;WY401&quot;,&quot;person&quot;:[&quot;Maude&quot;,&quot;Goulet&quot;]}              |
| 8     | 1      | {&quot;machine&quot;:&quot;AutoPlate 9000&quot;}                                 |
</code></pre></div>
</div>
<ul>
<li>SQLite and other database managers have many <a href="https://sqlite.org/json1.html">JSON manipulation functions</a></li>
<li><code>json_array_length</code> gives number of elements in selected array</li>
<li>Subscripts start with 0</li>
<li>Characters outside 7-bit ASCII represented as Unicode escapes</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">73: Unpacking JSON Arrays</h2>
<p class="inclusion"><a href="src/json_unpack.sql">src/json_unpack.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">ident</span><span class="p">,</span>
<span class="w">    </span><span class="n">json_each</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">key</span><span class="p">,</span>
<span class="w">    </span><span class="n">json_each</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">value</span>
<span class="k">from</span><span class="w"> </span><span class="k">usage</span><span class="p">,</span><span class="w"> </span><span class="n">json_each</span><span class="p">(</span><span class="k">usage</span><span class="p">.</span><span class="n">log</span><span class="p">)</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_unpack.out">out/json_unpack.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident | key |                            value                             |
|-------|-----|--------------------------------------------------------------|
| 1     | 0   | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Gabrielle&quot;,&quot;Dub\u00e9&quot;]}   |
| 1     | 1   | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Gabrielle&quot;,&quot;Dub\u00e9&quot;]}   |
| 1     | 2   | {&quot;machine&quot;:&quot;WY401&quot;,&quot;person&quot;:[&quot;Gabrielle&quot;,&quot;Dub\u00e9&quot;]}       |
| 1     | 3   | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Gabrielle&quot;,&quot;Dub\u00e9&quot;]}   |
| 2     | 0   | {&quot;machine&quot;:&quot;Inphormex&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}       |
| 2     | 1   | {&quot;machine&quot;:&quot;AutoPlate 9000&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}  |
| 2     | 2   | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}      |
| 2     | 3   | {&quot;machine&quot;:&quot;AutoPlate 9000&quot;,&quot;person&quot;:[&quot;Monique&quot;,&quot;Marcotte&quot;]} |
| 2     | 4   | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Marianne&quot;,&quot;Richer&quot;]}      |
| 3     | 0   | {&quot;machine&quot;:&quot;sterilizer&quot;,&quot;person&quot;:[&quot;Josette&quot;,&quot;Villeneuve&quot;]}   |
</code></pre></div>
</div>
<ul>
<li><code>json_each</code> is another table-valued function</li>
<li>Use <code>json_each.<em>name</em></code> to get properties of unpacked array</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 47</strong>:
Write a query that counts how many times each person appears
in the first log entry associated with any piece of equipment.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">74: Selecting the Last Element of an  Array</h2>
<p class="inclusion"><a href="src/json_array_last.sql">src/json_array_last.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">ident</span><span class="p">,</span>
<span class="w">    </span><span class="n">log</span><span class="o">-&gt;</span><span class="s1">&#39;$[#-1].machine&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">final</span>
<span class="k">from</span><span class="w"> </span><span class="k">usage</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_array_last.out">out/json_array_last.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident |    final     |
|-------|--------------|
| 1     | &quot;Inphormex&quot;  |
| 2     | &quot;sterilizer&quot; |
| 3     | &quot;Inphormex&quot;  |
| 4     | &quot;sterilizer&quot; |
| 5     | &quot;sterilizer&quot; |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">75: Modifying JSON</h2>
<p class="inclusion"><a href="src/json_modify.sql">src/json_modify.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">ident</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="n">json_set</span><span class="p">(</span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$.sold&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">json_quote</span><span class="p">(</span><span class="s1">&#39;2024-01-25&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">updated</span>
<span class="k">from</span><span class="w"> </span><span class="n">machine</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/json_modify.out">out/json_modify.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident |      name      |                           updated                            |
|-------|----------------|--------------------------------------------------------------|
| 1     | WY401          | {&quot;acquired&quot;:&quot;2023-05-01&quot;,&quot;sold&quot;:&quot;2024-01-25&quot;}                |
| 2     | Inphormex      | {&quot;acquired&quot;:&quot;2021-07-15&quot;,&quot;refurbished&quot;:&quot;2023-10-22&quot;,&quot;sold&quot;:&quot; |
|       |                | 2024-01-25&quot;}                                                 |
| 3     | AutoPlate 9000 | {&quot;note&quot;:&quot;needs software update&quot;,&quot;sold&quot;:&quot;2024-01-25&quot;}         |
</code></pre></div>
</div>
<ul>
<li>Updates the in-memory copy of the JSON, <em>not</em> the database record</li>
<li>Please use <code>json_quote</code> rather than trying to format JSON with string operations</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 48</strong>:
As part of cleaning up the lab log database,
replace the machine names in the JSON records in <code>usage</code>
with the corresopnding machine IDs from the <code>machine</code> table.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Refreshing the Penguins Database</h2>
<p class="inclusion"><a href="src/count_penguins.sql">src/count_penguins.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/count_penguins.out">out/count_penguins.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  | num |
|-----------|-----|
| Adelie    | 152 |
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>
</div>
<ul>
<li>We will restore full database after each example</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">76: Tombstones</h2>
<p class="inclusion"><a href="src/make_active.sql">src/make_active.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">add</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">set</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iif</span><span class="p">(</span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Adelie&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/active_penguins.sql">src/active_penguins.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">active</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/active_penguins.out">out/active_penguins.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>
</div>
<ul>
<li>Use a <a href="#g:tombstone">tombstone</a> to mark (in)active records</li>
<li>Every query must now include it</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Importing CSV Data</h2>
<ul>
<li>SQLite and most other database managers have tools for importing and exporting <a href="#g:csv">CSV</a></li>
<li>In SQLite:<ul>
<li>Define table</li>
<li>Import data</li>
<li>Convert empty strings to nulls (if desired)</li>
<li>Convert types from text to whatever (not shown below)</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/create_penguins.sql">src/create_penguins.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">penguins</span><span class="p">;</span>
<span class="p">.</span><span class="k">mode</span><span class="w"> </span><span class="n">csv</span><span class="w"> </span><span class="n">penguins</span>
<span class="p">.</span><span class="n">import</span><span class="w"> </span><span class="n">misc</span><span class="o">/</span><span class="n">penguins</span><span class="p">.</span><span class="n">csv</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">bill_length_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">bill_length_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">bill_depth_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">bill_depth_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">flipper_length_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">flipper_length_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">body_mass_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">update</span><span class="w"> </span><span class="n">penguins</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 49</strong>:
What are the data types of the columns in the <code>penguins</code> table
created by the CSV import shown above?
How can you correct the ones that need correcting?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">77: Views</h2>
<p class="inclusion"><a href="src/views.sql">src/views.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span>
<span class="n">active_penguins</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span><span class="p">,</span>
<span class="w">    </span><span class="n">bill_length_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">bill_depth_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">flipper_length_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="n">island</span><span class="p">,</span>
<span class="w">    </span><span class="n">bill_length_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">bill_depth_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">flipper_length_mm</span><span class="p">,</span>
<span class="w">    </span><span class="n">body_mass_g</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span>
<span class="k">from</span><span class="w"> </span><span class="n">penguins</span>
<span class="k">where</span><span class="w"> </span><span class="n">active</span><span class="p">;</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">species</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num</span>
<span class="k">from</span><span class="w"> </span><span class="n">active_penguins</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">species</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/views.out">out/views.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>
</div>
<ul>
<li>A <a href="#g:view">view</a> is a saved query that other queries can invoke</li>
<li>View is re-run each time it&rsquo;s used</li>
<li>Like a CTE, but:<ul>
<li>Can be shared between queries</li>
<li>Views came first</li>
</ul>
</li>
<li>Some databases offer <a href="#g:materialized_view">materialized views</a><ul>
<li>Update-on-demand temporary tables</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 50</strong>:
Create a view in the lab log database called <code>busy</code> with two columns:
<code>machine_id</code> and <code>total_log_length</code>.
The first column records the numeric ID of each machine;
the second shows the total number of log entries for that machine.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_9">
<img src="img/concept_map_temp.svg" alt="box and arrow diagram showing different kinds of temporary 'tables' in SQL"/>
<figcaption>Figure 9: temporary tables</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Hours Reminder</h2>
<p class="inclusion"><a href="src/all_jobs.sql">src/all_jobs.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/all_jobs.out">out/all_jobs.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">78: Adding Checks</h2>
<p class="inclusion"><a href="src/all_jobs_check.sql">src/all_jobs_check.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">billable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/all_jobs_check.out">out/all_jobs_check.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Runtime error near line 9: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>
</div>
<ul>
<li><code>check</code> adds constraint to table<ul>
<li>Must produce a Boolean result</li>
<li>Run each time values added or modified</li>
</ul>
</li>
<li>But changes made before the error have taken effect</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 51</strong>:
Rewrite the definition of the <code>penguins</code> table to add the following constraints:</p>
<ol>
<li>
<p><code>body_mass_g</code> must be null or non-negative.</p>
</li>
<li>
<p><code>island</code> must be one of <code>"Biscoe"</code>, <code>"Dream"</code>, or <code>"Torgersen"</code>.
    (Hint: the <code>in</code> operator will be useful here.)</p>
</li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">ACID</h2>
<ul>
<li><a href="#g:atomic">Atomic</a>: change cannot be broken down into smaller ones (i.e., all or nothing)</li>
<li><a href="#g:consistent">Consistent</a>: database goes from one consistent state to another</li>
<li><a href="#g:isolated">Isolated</a>: looks like changes happened one after another</li>
<li><a href="#g:durable">Durable</a>: if change takes place, it&rsquo;s still there after a restart</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">79: Transactions</h2>
<p class="inclusion"><a href="src/transaction.sql">src/transaction.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">billable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">begin</span><span class="w"> </span><span class="k">transaction</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">rollback</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/transaction.out">out/transaction.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>
</div>
<ul>
<li>Statements outside transaction execute and are committed immediately</li>
<li>Statement(s) inside transaction don&rsquo;t take effect until:<ul>
<li><code>end transaction</code> (success)</li>
<li><code>rollback</code> (undo)</li>
</ul>
</li>
<li>Can have any number of statements inside a transaction</li>
<li>But <em>cannot</em> nest transactions in SQLite<ul>
<li>Other databases support this</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">80: Rollback in Constraints</h2>
<p class="inclusion"><a href="src/rollback_constraint.sql">src/rollback_constraint.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">billable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">conflict</span><span class="w"> </span><span class="k">rollback</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/rollback_constraint.out">out/rollback_constraint.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>
</div>
<ul>
<li>All of second <code>insert</code> rolled back as soon as error occurred</li>
<li>But first <code>insert</code> took effect</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">81: Rollback in Statements</h2>
<p class="inclusion"><a href="src/rollback_statement.sql">src/rollback_statement.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">billable</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">billable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">rollback</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">rollback</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/rollback_statement.out">out/rollback_statement.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>
</div>
<ul>
<li>Constraint is in table definition</li>
<li>Action is in statement</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">82: Upsert</h2>
<p class="inclusion"><a href="src/upsert.sql">src/upsert.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">jobs_done</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">unique</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">jobs_done</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;zia&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">.</span><span class="n">print</span><span class="w"> </span><span class="s1">&#39;after first&#39;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">jobs_done</span><span class="p">;</span>
<span class="p">.</span><span class="n">print</span>


<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">jobs_done</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;zia&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">.</span><span class="n">print</span><span class="w"> </span><span class="s1">&#39;after failed&#39;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">jobs_done</span><span class="p">;</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">jobs_done</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;zia&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">on</span><span class="w"> </span><span class="n">conflict</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">.</span><span class="n">print</span><span class="w"> </span><span class="s1">&#39;\nafter upsert&#39;</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">jobs_done</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/upsert.out">out/upsert.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>after first
| person | num |
|--------|-----|
| zia    | 1   |

Runtime error near line 15: UNIQUE constraint failed: jobs_done.person (19)
after failed
| person | num |
|--------|-----|
| zia    | 1   |
\nafter upsert
| person | num |
|--------|-----|
| zia    | 2   |
</code></pre></div>
</div>
<ul>
<li><a href="#g:upsert">upsert</a> stands for &ldquo;update or insert&rdquo;<ul>
<li>Create if record doesn&rsquo;t exist</li>
<li>Update if it does</li>
</ul>
</li>
<li>Not standard SQL but widely implemented</li>
<li>Example also shows use of SQLite <code>.print</code> command</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 52</strong>:
Using the assay database,
write a query that adds or modifies people in the <code>staff</code> table as shown:</p>
<table>
<thead>
<tr>
<th>personal</th>
<th>family</th>
<th>dept</th>
<th>age</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pranay</td>
<td>Khanna</td>
<td>mb</td>
<td>41</td>
</tr>
<tr>
<td>Riaan</td>
<td>Dua</td>
<td>gen</td>
<td>23</td>
</tr>
<tr>
<td>Parth</td>
<td>Johel</td>
<td>gen</td>
<td>27</td>
</tr>
</tbody>
</table>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Normalization</h2>
<ul>
<li>
<p>First <a href="#g:normal_form">normal form</a> (1NF):
    every field of every record contains one indivisible value.</p>
</li>
<li>
<p>Second normal form (2NF) and third normal form (3NF):
    every value in a record that isn&rsquo;t a key depends solely on the key,
    not on other values.</p>
</li>
<li>
<p><a href="#g:denormalization">Denormalization</a>: explicitly store values that could be calculated on the fly</p>
<ul>
<li>To simplify queries and/or make processing faster</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">83: Creating Triggers</h2>
<p class="inclusion"><a href="src/trigger_setup.sql">src/trigger_setup.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="c1">-- Track hours of lab work.</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">reported</span><span class="w"> </span><span class="nb">real</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">reported</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Explicitly store per-person total rather than using sum().</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">person</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">unique</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">hours</span><span class="w"> </span><span class="nb">real</span>
<span class="p">);</span>

<span class="c1">-- Initialize totals.</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;august&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">-- Define a trigger.</span>
<span class="k">create</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">total_trigger</span>
<span class="k">before</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">job</span>
<span class="k">begin</span>
<span class="w">    </span><span class="c1">-- Check that the person exists.</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">case</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="n">person</span><span class="p">)</span>
<span class="w">        </span><span class="k">then</span><span class="w"> </span><span class="n">raise</span><span class="p">(</span><span class="k">rollback</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown person &#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span><span class="p">;</span>
<span class="w">    </span><span class="c1">-- Update their total hours (or fail if non-negative constraint violated).</span>
<span class="w">    </span><span class="k">update</span><span class="w"> </span><span class="n">total</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="n">reported</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">total</span><span class="p">.</span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>
</code></pre></div>
</div>
<ul>
<li>A <a href="#g:trigger">trigger</a> automatically runs before or after a specified operation</li>
<li>Can have side effects (e.g., update some other table)</li>
<li>And/or implement checks (e.g., make sure other records exist)</li>
<li>Add processing overhead…</li>
<li>…but data is either cheap or correct, never both</li>
<li>Inside trigger, refer to old and new versions of record
    as <code>old.<em>column</em></code> and <code>new.<em>column</em></code></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">84: Trigger Not Firing</h2>
<p class="inclusion"><a href="src/trigger_successful.sql">src/trigger_successful.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;august&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/trigger_successful.out">out/trigger_successful.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| person | reported |
|--------|----------|
| gene   | 1.5      |
| august | 0.5      |
| gene   | 1.0      |

| person | hours |
|--------|-------|
| gene   | 2.5   |
| august | 0.5   |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">85: Trigger Firing</h2>
<p class="inclusion"><a href="src/trigger_firing.sql">src/trigger_firing.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;august&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/trigger_firing.out">out/trigger_firing.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Runtime error near line 6: CHECK constraint failed: reported &gt;= 0.0 (19)

| person | hours |
|--------|-------|
| gene   | 0.0   |
| august | 0.0   |
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 53</strong>:
Using the penguins database:</p>
<ol>
<li>
<p>create a table called <code>species</code> with columns <code>name</code> and <code>count</code>; and</p>
</li>
<li>
<p>define a trigger that increments the count associated with each species
    each time a new penguin is added to the <code>penguins</code> table.</p>
</li>
</ol>
<p>Does your solution behave correctly when several penguins are added
by a single <code>insert</code> statement?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Represent Graphs</h2>
<p class="inclusion"><a href="src/lineage_setup.sql">src/lineage_setup.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">lineage</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">parent</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">child</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lineage</span><span class="w"> </span><span class="k">values</span>
<span class="p">(</span><span class="s1">&#39;Arturo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Clemente&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Darío&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Clemente&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Clemente&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Homero&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Clemente&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Ivonne&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Ivonne&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Lourdes&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Soledad&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Lourdes&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;Lourdes&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Santiago&#39;</span><span class="p">);</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/represent_graph.sql">src/represent_graph.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">lineage</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/represent_graph.out">out/represent_graph.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  parent  |  child   |
|----------|----------|
| Arturo   | Clemente |
| Darío    | Clemente |
| Clemente | Homero   |
| Clemente | Ivonne   |
| Ivonne   | Lourdes  |
| Soledad  | Lourdes  |
| Lourdes  | Santiago |
</code></pre></div>
</div>
<figure id="figure_10">
<img src="img/lineage.svg" alt="box and arrow diagram showing who is descended from whom in the lineage database"/>
<figcaption>Figure 10: lineage diagram</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 54</strong>:
Write a query that uses a self join to find every person&rsquo;s grandchildren.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">86: Recursive Queries</h2>
<p class="inclusion"><a href="src/recursive_lineage.sql">src/recursive_lineage.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="k">recursive</span><span class="w"> </span><span class="n">descendent</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="s1">&#39;Clemente&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">generations</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">lineage</span><span class="p">.</span><span class="n">child</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">person</span><span class="p">,</span>
<span class="w">        </span><span class="n">descendent</span><span class="p">.</span><span class="n">generations</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">generations</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">descendent</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">lineage</span>
<span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="n">descendent</span><span class="p">.</span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lineage</span><span class="p">.</span><span class="n">parent</span>
<span class="p">)</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">person</span><span class="p">,</span>
<span class="w">    </span><span class="n">generations</span>
<span class="k">from</span><span class="w"> </span><span class="n">descendent</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/recursive_lineage.out">out/recursive_lineage.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|  person  | generations |
|----------|-------------|
| Clemente | 0           |
| Homero   | 1           |
| Ivonne   | 1           |
| Lourdes  | 2           |
| Santiago | 3           |
</code></pre></div>
</div>
<ul>
<li>Use a <a href="#g:recursive_cte">recursive CTE</a> to create a temporary table (<code>descendent</code>)</li>
<li><a href="#g:base_case">Base case</a> seeds this table</li>
<li><a href="#g:recursive_case">Recursive case</a> relies on value(s) already in that table and external table(s)</li>
<li><code>union all</code> to combine rows<ul>
<li>Can use <code>union</code> but that has lower performance (must check uniqueness each time)</li>
</ul>
</li>
<li>Stops when the recursive case yields an empty row set (nothing new to add)</li>
<li>Then select the desired values from the CTE</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 55</strong>:
Modify the recursive query shown above to use <code>union</code> instead of <code>union all</code>.
Does this affect the result?
Why or why not?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Contact Tracing Database</h2>
<p class="inclusion"><a href="src/contact_person.sql">src/contact_person.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">person</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/contact_person.out">out/contact_person.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| ident |         name          |
|-------|-----------------------|
| 1     | Juana Baeza           |
| 2     | Agustín Rodríquez     |
| 3     | Ariadna Caraballo     |
| 4     | Micaela Laboy         |
| 5     | Verónica Altamirano   |
| 6     | Reina Rivero          |
| 7     | Elias Merino          |
| 8     | Minerva Guerrero      |
| 9     | Mauro Balderas        |
| 10    | Pilar Alarcón         |
| 11    | Daniela Menéndez      |
| 12    | Marco Antonio Barrera |
| 13    | Cristal Soliz         |
| 14    | Bernardo Narváez      |
| 15    | Óscar Barrios         |
</code></pre></div>
</div>
<p class="inclusion"><a href="src/contact_contacts.sql">src/contact_contacts.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">contact</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/contact_contacts.out">out/contact_contacts.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|       left        |         right         |
|-------------------|-----------------------|
| Agustín Rodríquez | Ariadna Caraballo     |
| Agustín Rodríquez | Verónica Altamirano   |
| Juana Baeza       | Verónica Altamirano   |
| Juana Baeza       | Micaela Laboy         |
| Pilar Alarcón     | Reina Rivero          |
| Cristal Soliz     | Marco Antonio Barrera |
| Cristal Soliz     | Daniela Menéndez      |
| Daniela Menéndez  | Marco Antonio Barrera |
</code></pre></div>
</div>
<figure id="figure_11">
<img src="img/contact_tracing.svg" alt="box and line diagram showing who has had contact with whom"/>
<figcaption>Figure 11: contact diagram</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">87: Bidirectional Contacts</h2>
<p class="inclusion"><a href="src/bidirectional.sql">src/bidirectional.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">temporary</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">bi_contact</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">left</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">    </span><span class="k">right</span><span class="w"> </span><span class="nb">text</span>
<span class="p">);</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">bi_contact</span>
<span class="k">select</span>
<span class="w">    </span><span class="k">left</span><span class="p">,</span><span class="w"> </span><span class="k">right</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">contact</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">right</span><span class="p">,</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">contact</span>
<span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/bidirectional.out">out/bidirectional.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>| original_count |
|----------------|
| 8              |

| num_contact |
|-------------|
| 16          |
</code></pre></div>
</div>
<ul>
<li>Create a <a href="#g:temporary_table">temporary table</a> rather than using a long chain of CTEs<ul>
<li>Only lasts as long as the session (not saved to disk)</li>
</ul>
</li>
<li>Duplicate information rather than writing more complicated query</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">88: Updating Group Identifiers</h2>
<p class="inclusion"><a href="src/update_group_ids.sql">src/update_group_ids.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">select</span>
<span class="w">    </span><span class="k">left</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">left</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">left_ident</span><span class="p">,</span>
<span class="w">    </span><span class="k">right</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">right</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_ident</span><span class="p">,</span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="k">left</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span><span class="w"> </span><span class="k">right</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">new_ident</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">bi_contact</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">left</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bi_contact</span><span class="p">.</span><span class="k">left</span><span class="p">)</span>
<span class="w">    </span><span class="k">join</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">right</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">bi_contact</span><span class="p">.</span><span class="k">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">right</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/update_group_ids.out">out/update_group_ids.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|       left_name       | left_ident |      right_name       | right_ident | new_ident |
|-----------------------|------------|-----------------------|-------------|-----------|
| Juana Baeza           | 1          | Micaela Laboy         | 4           | 1         |
| Juana Baeza           | 1          | Verónica Altamirano   | 5           | 1         |
| Agustín Rodríquez     | 2          | Ariadna Caraballo     | 3           | 2         |
| Agustín Rodríquez     | 2          | Verónica Altamirano   | 5           | 2         |
| Ariadna Caraballo     | 3          | Agustín Rodríquez     | 2           | 2         |
| Micaela Laboy         | 4          | Juana Baeza           | 1           | 1         |
| Verónica Altamirano   | 5          | Agustín Rodríquez     | 2           | 2         |
| Verónica Altamirano   | 5          | Juana Baeza           | 1           | 1         |
| Reina Rivero          | 6          | Pilar Alarcón         | 10          | 6         |
| Pilar Alarcón         | 10         | Reina Rivero          | 6           | 6         |
| Daniela Menéndez      | 11         | Cristal Soliz         | 13          | 11        |
| Daniela Menéndez      | 11         | Marco Antonio Barrera | 12          | 11        |
| Marco Antonio Barrera | 12         | Cristal Soliz         | 13          | 12        |
| Marco Antonio Barrera | 12         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Marco Antonio Barrera | 12          | 12        |
</code></pre></div>
</div>
<ul>
<li><code>new_ident</code> is minimum of own identifier and identifiers one step away</li>
<li>Doesn&rsquo;t keep people with no contacts</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">89: Recursive Labeling</h2>
<p class="inclusion"><a href="src/recursive_labeling.sql">src/recursive_labeling.sql</a></p>
<div class="language-sql">
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="k">recursive</span><span class="w"> </span><span class="n">labeled</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">        </span><span class="n">person</span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">label</span>
<span class="w">    </span><span class="k">from</span>
<span class="w">        </span><span class="n">person</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="c1">-- not &#39;union all&#39;</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">        </span><span class="n">labeled</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">label</span>
<span class="w">    </span><span class="k">from</span>
<span class="w">        </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">bi_contact</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bi_contact</span><span class="p">.</span><span class="k">left</span><span class="p">)</span>
<span class="w">        </span><span class="k">join</span><span class="w"> </span><span class="n">labeled</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">bi_contact</span><span class="p">.</span><span class="k">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labeled</span><span class="p">.</span><span class="n">name</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">labeled</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="n">ident</span>
<span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">group_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">labeled</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/recursive_labeling.out">out/recursive_labeling.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>|         name          | group_id |
|-----------------------|----------|
| Agustín Rodríquez     | 1        |
| Ariadna Caraballo     | 1        |
| Juana Baeza           | 1        |
| Micaela Laboy         | 1        |
| Verónica Altamirano   | 1        |
| Pilar Alarcón         | 6        |
| Reina Rivero          | 6        |
| Elias Merino          | 7        |
| Minerva Guerrero      | 8        |
| Mauro Balderas        | 9        |
| Cristal Soliz         | 11       |
| Daniela Menéndez      | 11       |
| Marco Antonio Barrera | 11       |
| Bernardo Narváez      | 14       |
| Óscar Barrios         | 15       |
</code></pre></div>
</div>
<ul>
<li>Use <code>union</code> instead of <code>union all</code> to prevent <a href="#g:infinite_recursion">infinite recursion</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 56</strong>:
Modify the query above to use <code>union all</code> instead of <code>union</code> to trigger infinite recursion.
How can you modify the query so that it stops at a certain depth
so that you can trace its output?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Check Understanding</h2>
<figure id="figure_12">
<img src="img/concept_map_cte.svg" alt="box and arrow diagram showing concepts related to common table expressions in SQL"/>
<figcaption>Figure 12: common table expressions</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">90: Querying from Python</h2>
<p class="inclusion"><a href="src/basic_python_query.py">src/basic_python_query.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;db/penguins.db&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select count(*) from penguins;&quot;</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/basic_python_query.out">out/basic_python_query.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>[(344,)]
</code></pre></div>
</div>
<ul>
<li><code>sqlite3</code> is part of Python&rsquo;s standard library</li>
<li>Create a connection to a database file</li>
<li>Get a <a href="#g:cursor">cursor</a> by executing a query<ul>
<li>More common to create cursor and use that to run queries</li>
</ul>
</li>
<li>Fetch all rows at once as list of tuples</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">91: Incremental Fetch</h2>
<p class="inclusion"><a href="src/incremental_fetch.py">src/incremental_fetch.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;db/penguins.db&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select species, island from penguins limit 5;&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="n">row</span> <span class="o">:=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/incremental_fetch.out">out/incremental_fetch.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
</code></pre></div>
</div>
<ul>
<li><code>cursor.fetchone</code> returns <code>None</code> when no more data</li>
<li>There is also <code>fetchmany(N)</code> to fetch (up to) a certain number of rows</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">92: Insert, Delete, and All That</h2>
<p class="inclusion"><a href="src/insert_delete.py">src/insert_delete.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table example(num integer);&quot;</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into example values (10), (20);&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after insertion&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;delete from example where num &lt; 15;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after deletion&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/insert_delete.out">out/insert_delete.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>after insertion [(10,), (20,)]
after deletion [(20,)]
</code></pre></div>
</div>
<ul>
<li>Each <code>execute</code> is its own transaction</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">93: Interpolating Values</h2>
<p class="inclusion"><a href="src/interpolate.py">src/interpolate.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table example(num integer);&quot;</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;insert into example values (?);&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after insertion&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/interpolate.out">out/interpolate.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>after insertion [(10,), (20,)]
</code></pre></div>
</div>
<ul>
<li>From <a href="https://xkcd.com/327/">XKCD</a></li>
</ul>
<figure id="figure_13">
<img src="img/xkcd_327_exploits_of_a_mom.png" alt="XKCD cartoon showing a mother scolding a school for not being more careful about SQL injection attacks"/>
<figcaption>Figure 13: XKCD Exploits of a Mom</figcaption>
</figure>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 57</strong>:
Write a Python script that takes island, species, sex, and other values as command-line arguments
and inserts an entry into the penguins database.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">94: Script Execution</h2>
<p class="inclusion"><a href="src/script_execution.py">src/script_execution.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">drop table if exists example;</span>
<span class="s2">create table example(num integer);</span>
<span class="s2">insert into example values (10), (20);</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after insertion&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/script_execution.out">out/script_execution.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>after insertion [(10,), (20,)]
</code></pre></div>
</div>
<ul>
<li>But what if something goes wrong?</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">95: SQLite Exceptions in Python</h2>
<p class="inclusion"><a href="src/exceptions.py">src/exceptions.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">create table example(num integer check(num &gt; 0));</span>
<span class="s2">insert into example values (10);</span>
<span class="s2">insert into example values (-1);</span>
<span class="s2">insert into example values (20);</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLite exception: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after execution&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/exceptions.out">out/exceptions.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>SQLite exception: CHECK constraint failed: num &gt; 0
after execution [(10,)]
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">96: Python in SQLite</h2>
<p class="inclusion"><a href="src/embedded_python.py">src/embedded_python.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">create table example(num integer);</span>
<span class="s2">insert into example values (-10), (10), (20), (30);</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">20</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s2">&quot;clip&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select num, clip(num) from example;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/embedded_python.out">out/embedded_python.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>(-10, 0)
(10, 10)
(20, 20)
(30, 20)
</code></pre></div>
</div>
<ul>
<li>SQLite calls back into Python to execute the function</li>
<li>Other databases can run Python (and other languages) in the database server process</li>
<li>Be careful</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">97: Handling Dates and Times</h2>
<p class="inclusion"><a href="src/dates_times.py">src/dates_times.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="c1"># Convert date to ISO-formatted string when writing to database</span>
<span class="k">def</span> <span class="nf">_adapt_date_iso</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>


<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">_adapt_date_iso</span><span class="p">)</span>


<span class="c1"># Convert ISO-formatted string to date when reading from database</span>
<span class="k">def</span> <span class="nf">_convert_date</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">_convert_date</span><span class="p">)</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">create table events(</span>
<span class="s2">    happened date not null,</span>
<span class="s2">    description text not null</span>
<span class="s2">);</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
    <span class="s2">&quot;insert into events values (?, ?);&quot;</span><span class="p">,</span>
    <span class="p">[(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">&quot;started tutorial&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="s2">&quot;finished tutorial&quot;</span><span class="p">)],</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from events;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/dates_times.out">out/dates_times.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>(datetime.date(2024, 1, 10), &#39;started tutorial&#39;)
(datetime.date(2024, 1, 29), &#39;finished tutorial&#39;)
</code></pre></div>
</div>
<ul>
<li><code>sqlite3.PARSE_DECLTYPES</code> tells <code>sqlite3</code> library to use converts based on declared column types</li>
<li>Adapt on the way in, convert on the way out</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 58</strong>:
Write a Python adapter that truncates real values to two decimal places
as they are being written to the database.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">98: SQL in Jupyter Notebooks</h2>
<p class="inclusion"><a href="src/install_jupysql.sh">src/install_jupysql.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>jupysql
</code></pre></div>
</div>
<ul>
<li>And then inside the notebook:</li>
</ul>
<p class="inclusion"><a href="src/load_ext.text">src/load_ext.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>%load_ext sql
</code></pre></div>
</div>
<ul>
<li>Loads extension</li>
</ul>
<p class="inclusion"><a href="src/jupyter_connect.text">src/jupyter_connect.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>%sql sqlite:///data/penguins.db
</code></pre></div>
</div>
<p class="inclusion"><a href="out/jupyter_connect.out">out/jupyter_connect.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Connecting to &#39;sqlite:///data/penguins.db&#39;
</code></pre></div>
</div>
<ul>
<li>Connects to database<ul>
<li><code>sqlite://</code> with two slashes is the protocol</li>
<li><code>/data/penguins.db</code> (one leading slash) is a local path</li>
</ul>
</li>
<li>Single percent sign <code>%sql</code> introduces one-line command</li>
<li>Use double percent sign <code>%%sql</code> to indicate that the rest of the cell is SQL</li>
</ul>
<p class="inclusion"><a href="src/jupyter_select.text">src/jupyter_select.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>%%sql
select species, count(*) as num
from penguins
group by species;
</code></pre></div>
</div>
<p class="inclusion"><a href="out/jupyter_select.out">out/jupyter_select.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Running query in &#39;sqlite:///data/penguins.db&#39;
</code></pre></div>
</div>
<table>
<thead>
    <tr>
      <th>species</th>
      <th>num</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <td>Adelie</td>
      <td>152</td>
    </tr>
    <tr>
      <td>Chinstrap</td>
      <td>68</td>
    </tr>
    <tr>
      <td>Gentoo</td>
      <td>124</td>
    </tr>
  </tbody>
</table>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">99: Pandas and SQL</h2>
<p class="inclusion"><a href="src/install_pandas.sh">src/install_pandas.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pandas
</code></pre></div>
</div>
<p class="inclusion"><a href="src/select_pandas.py">src/select_pandas.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;db/penguins.db&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select species, count(*) as num from penguins group by species;&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/select_pandas.out">out/select_pandas.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>species  num
0     Adelie  152
1  Chinstrap   68
2     Gentoo  124
</code></pre></div>
</div>
<ul>
<li>Be careful about datatype conversion when using <a href="https://pandas.pydata.org/">Pandas</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 59</strong>:
Write a command-line Python script that uses Pandas to re-create the penguins database.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">100: Polars and SQL</h2>
<p class="inclusion"><a href="src/install_polars.sh">src/install_polars.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>polars<span class="w"> </span>pyarrow<span class="w"> </span>adbc-driver-sqlite
</code></pre></div>
</div>
<p class="inclusion"><a href="src/select_polars.py">src/select_polars.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select species, count(*) as num from penguins group by species;&quot;</span>
<span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///db/penguins.db&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_database_uri</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;adbc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/select_polars.out">out/select_polars.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>shape: (3, 2)
┌───────────┬─────┐
│ species   ┆ num │
│ ---       ┆ --- │
│ str       ┆ i64 │
╞═══════════╪═════╡
│ Adelie    ┆ 152 │
│ Chinstrap ┆ 68  │
│ Gentoo    ┆ 124 │
└───────────┴─────┘
</code></pre></div>
</div>
<ul>
<li>The <a href="#g:uri">Uniform Resource Identifier</a> (URI) specifies the database</li>
<li>The query is the query</li>
<li>Use the ADBC engine instead of the default ConnectorX with <a href="https://pola.rs/">Polars</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 60</strong>:
Write a command-line Python script that uses Polars to re-create the penguins database.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">101: Object-Relational Mappers</h2>
<p class="inclusion"><a href="src/orm.py">src/orm.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">select</span>


<span class="k">class</span> <span class="nc">Department</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">building</span><span class="p">:</span> <span class="nb">str</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///db/assays.db&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/orm.out">out/orm.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>building=&#39;Chesson&#39; name=&#39;Genetics&#39; ident=&#39;gen&#39;
building=&#39;Fashet Extension&#39; name=&#39;Histology&#39; ident=&#39;hist&#39;
building=&#39;Chesson&#39; name=&#39;Molecular Biology&#39; ident=&#39;mb&#39;
building=&#39;TGVH&#39; name=&#39;Endocrinology&#39; ident=&#39;end&#39;
</code></pre></div>
</div>
<ul>
<li>An <a href="#g:orm">object-relational mapper</a> (ORM) translates table columns to object properties and vice versa</li>
<li><a href="https://sqlmodel.tiangolo.com/">SQLModel</a> relies on Python type hints</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 61</strong>:
Write a command-line Python script that uses SQLModel to re-create the penguins database.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">102: Relations with ORMs</h2>
<p class="inclusion"><a href="src/orm_relation.py">src/orm_relation.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Staff</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">personal</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">family</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dept</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">=</span><span class="s2">&quot;department.ident&quot;</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///db/assays.db&quot;</span><span class="p">)</span>
<span class="n">SQLModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">,</span> <span class="n">Staff</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Staff</span><span class="o">.</span><span class="n">dept</span> <span class="o">==</span> <span class="n">Department</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dept</span><span class="p">,</span> <span class="n">staff</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dept</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">staff</span><span class="o">.</span><span class="n">personal</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">staff</span><span class="o">.</span><span class="n">family</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/orm_relation.out">out/orm_relation.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Histology: Divit Dhaliwal
Molecular Biology: Indrans Sridhar
Molecular Biology: Pranay Khanna
Histology: Vedika Rout
Genetics: Abram Chokshi
Histology: Romil Kapoor
Molecular Biology: Ishaan Ramaswamy
Genetics: Nitya Lal
</code></pre></div>
</div>
<ul>
<li>Make foreign keys explicit in class definitions</li>
<li>SQLModel automatically does the join<ul>
<li>The two staff with no department aren&rsquo;t included in the result</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Appendices</h2>
<h3>Glossary</h3>
<dl class="glossary">
<dt id="g:1_to_1">1-to-1 relation</dt><dd>A relationship between two tables in which each record from the first table matches exactly one record from the second and vice versa.</dd>

<dt id="g:1_to_many">1-to-many relation</dt><dd>A relationship between two tables in which each record from the first table matches zero or more records from the second, but each record from the second table matches exactly one record from the first.</dd>

<dt id="g:aggregation">aggregation</dt><dd>Combining several values to produce one.</dd>

<dt id="g:aggregation_func">aggregation function</dt><dd>A function used to produce one value from many, such as maximum or addition.</dd>

<dt id="g:alias">alias</dt><dd>An alternate name used temporarily for a table or column.</dd>

<dt id="g:atomic">atomic</dt><dd>An operation that cannot be broken into smaller operations.</dd>

<dt id="g:autoincrement">autoincrement</dt><dd>Automatically add one to a value.</dd>

<dt id="g:b_tree">B-tree</dt><dd>A self-balancing tree data structure that allows search, insertion, and deletion in logarithmic time.</dd>

<dt id="g:base_case">base case</dt><dd>A starting point for recursion that does not depend on previous recursive calculations.</dd>

<dt id="g:blob">Binary Large Object (blob)</dt><dd>Bytes that are handled as-is rather than being interpreted as numbers, text, or other data types.</dd>

<dt id="g:csv">comma-separated values (CSV)</dt><dd>A text format for tabular data that uses commas to separate columns.</dd>

<dt id="g:cte">common table expression (CTE)</dt><dd>A temporary table created at the start of a query, usually to simplify writing the query.</dd>

<dt id="g:consistent">consistent</dt><dd>A state in which all constraints are satisfied, e.g., all columns contain allowed values and all foreign keys refer to primary keys.</dd>

<dt id="g:correlated_subquery">correlated subquery</dt><dd>A subquery that depends on a value or values from the enclosing query, and which must therefore be executed once for each of those values.</dd>

<dt id="g:cross_join">cross join</dt><dd>A join that creates the cross-product of rows from two tables.</dd>

<dt id="g:cursor">cursor</dt><dd>A reference to the current location in the results of an ongoing query.</dd>

<dt id="g:data_migration">data migration</dt><dd>To move data from one form to another, e.g., from one set of tables to a new set or from one DBMS to another.</dd>

<dt id="g:database">database</dt><dd>A collection of data that can be searched and retrieved.</dd>

<dt id="g:dbms">database management system (DBMS)</dt><dd>A program that manages a particular kind of database.</dd>

<dt id="g:denormalization">denormalization</dt><dd>To deliberately introduce duplication or other violate normal forms, typically to improve query performance.</dd>

<dt id="g:durable">durable</dt><dd>Guaranteed to survive shutdown and restart.</dd>

<dt id="g:er_diagram">entity-relationship diagram</dt><dd>A graphical depiction of the relationships between tables in a database.</dd>

<dt id="g:exclusive_or">exclusive or</dt><dd>A Boolean operation that is true if either but not both of its conditions are true. SQL does not provide an exclusive or operator, but the same result can be achieved using operators it has.</dd>

<dt id="g:expression">expression</dt><dd>A part of a program that produces a value, such as <code>1+2</code>.</dd>

<dt id="g:filter">filter</dt><dd>To select records based on whether they pass some Boolean test.</dd>

<dt id="g:foreign_key">foreign key</dt><dd>A value in one table that identifies a primary key in another table.</dd>

<dt id="g:full_outer_join">full outer join</dt><dd>A join that produces the union of a left outer join and a right outer join.</dd>

<dt id="g:group">group</dt><dd>A set of records that share a common property, such as having the same value in a particular column.</dd>

<dt id="g:in_memory_db">in-memory database</dt><dd>A database that is stored in memory rather than on disk.</dd>

<dt id="g:inclusive_or">inclusive or</dt><dd>A Boolean operator that is true if either or both of its conditions are true. SQL&rsquo;s <code>or</code> is inclusive.</dd>

<dt id="g:index">index</dt><dd>An auxiliary data structure that enables faster access to records.</dd>

<dt id="g:infinite_recursion">infinite recursion</dt><dd>See &ldquo;infinite recursion&rdquo;.</dd>

<dt id="g:isolated">isolated</dt><dd>The appearance of having executed in an otherwise-idle system.</dd>

<dt id="g:json">JavaScript Object Notation (JSON)</dt><dd>A text format for representing numbers, strings, lists, and key-value maps.</dd>

<dt id="g:join">join</dt><dd>To combine records from two tables.</dd>

<dt id="g:join_condition">join condition</dt><dd>The criteria used to decide which rows from each table in a join are combined.</dd>

<dt id="g:join_table">join table</dt><dd>A table that exists solely to enable information from two tables to be connected.</dd>

<dt id="g:left_outer_join">left outer join</dt><dd>A join that is guaranteed to keep all rows from the first (left) table. Columns from the right table are filled with actual values if available or with null otherwise.</dd>

<dt id="g:many_to_many">many-to-many relation</dt><dd>A relationship between two tables in which each record from the first table may match zero or more records from the second and vice versa.</dd>

<dt id="g:materialized_view">materialized view</dt><dd>A view that is stored on disk and updated on demand.</dd>

<dt id="g:normal_form">normal form</dt><dd>One of several (loosely defined) rules for organizing data in tables.</dd>

<dt id="g:nosql">NoSQL database</dt><dd>Any database that doesn&rsquo;t use the relational model.</dd>

<dt id="g:null">null</dt><dd>A special value representing &ldquo;not known&rdquo;.</dd>

<dt id="g:orm">object-relational mapper (ORM)</dt><dd>A library that translates objects in a program into database queries and the results of those queries back into objects.</dd>

<dt id="g:path_expression">path expression</dt><dd>An expression identifying an element or a set of elements in a JSON structure.</dd>

<dt id="g:primary_key">primary key</dt><dd>A value or values in a database table that uniquely identifies each record in that table.</dd>

<dt id="g:query">query</dt><dd>A command to perform some operation in a database (typically data retrieval).</dd>

<dt id="g:recursive_case">recursive case</dt><dd>The second or subsequent step in self-referential accumulation of data.</dd>

<dt id="g:recursive_cte">recursive CTE</dt><dd>A common table expression that refers to itself. Every recursive CTE must have a base case and a recursive case.</dd>

<dt id="g:rdbms">relational database management system (RDBMS)</dt><dd>A database management system that stores data in tables with columns and rows.</dd>

<dt id="g:right_outer_join">right outer join</dt><dd>A join that is guaranteed to keep all rows from the second (right) table. Columns from the left table are filled with actual values if available or with null otherwise. SQLite does not implement right outer join since its behavior can be reproduced by swapping the order of the tables and using a left outer join.</dd>

<dt id="g:statement">statement</dt><dd>A part of a program that doesn&rsquo;t produce a value.</dd>

<dt id="g:subquery">subquery</dt><dd>A query used within another query.</dd>

<dt id="g:table_valued_func">table-valued function</dt><dd>A function that returns multiple values rather than a single value.</dd>

<dt id="g:temporary_table">temporary table</dt><dd>A table that is explicitly constructed in memory outside any particular query.</dd>

<dt id="g:ternary_logic">ternary logic</dt><dd>A logic based on three values: true, false, and &ldquo;don&rsquo;t know&rdquo; (represented as null).</dd>

<dt id="g:tombstone">tombstone</dt><dd>A marker value added to a record to show that it is no longer active. Tombstones are used as an alternative to deleting data.</dd>

<dt id="g:trigger">trigger</dt><dd>An action that runs automatically when something happens in a database, typically insertion or deletion.</dd>

<dt id="g:uri">Uniform Resource Identifier (URI)</dt><dd>A string that identifies a resource (such as a web page or database) and the protocol used to access it.</dd>

<dt id="g:upsert">upsert</dt><dd>To update a record if it exists or insert (create) a new record if it doesn&rsquo;t.</dd>

<dt id="g:vectorization">vectorization</dt><dd>Performing the same operation on a stream of values rather than using a loop to operate on one value at a time.</dd>

<dt id="g:view">view</dt><dd>A rearrangement of data in a database that is regenerated on demand.</dd>

<dt id="g:window_func">window function</dt><dd>A function that combines data from adjacent rows in a database query&rsquo;s result.</dd>
</dl>
<h3>Acknowledgments</h3>
<p>This tutorial would not have been possible without:</p>
<ul>
<li><a href="http://andialbrecht.de/">Andi Albrecht</a>&rsquo;s <a href="https://pypi.org/project/sqlparse/"><code>sqlparse</code></a> module</li>
<li><a href="https://tapoueh.org/">Dimitri Fontaine</a>&rsquo;s <a href="https://theartofpostgresql.com/"><em>The Art of PostgreSQL</em></a></li>
<li>David Rozenshtein&rsquo;s <em>The Essence of SQL</em> (now sadly out of print)</li>
</ul>
<p>I would also like to thank the following for spotting issues, making suggestions, or submitting changes:</p>
<ul><li>Phillip Cloud</li>
<li>Conor Flynn</li>
<li>Jay Graves</li>
<li>Sam Hames</li>
<li>Adam Hawkes</li>
<li>Robert Kern</li>
<li>Olivier Leroy</li>
<li>Kevin Marshall</li>
<li>Roy Pardee</li>
<li>Manos Pitsidianakis</li>
<li>Daniel Possenriede</li>
<li>Adam Rosien</li>
<li>Thomas Sandmann</li>
<li>Simon Willison</li>
</ul>
<h3>Links</h3>
<ul>
<li><em>Teaching Tech Together</em>: <a href="https://teachtogether.tech/">https://teachtogether.tech/</a></li>
<li><em>Teaching Tech Together</em> lesson on learner personas: <a href="http://teachtogether.tech/en/index.html#s:process-personas">http://teachtogether.tech/en/index.html#s:process-personas</a></li>
<li><em>The Art of PostgreSQL</em>: <a href="https://theartofpostgresql.com/">https://theartofpostgresql.com/</a></li>
<li>Ark static site generator: <a href="https://www.dmulholl.com/docs/ark/main/">https://www.dmulholl.com/docs/ark/main/</a></li>
<li>Fossil version control system (built on top of SQLite): <a href="https://fossil-scm.org/">https://fossil-scm.org/</a></li>
<li>MongoDB (a NoSQL database): <a href="https://www.mongodb.com/">https://www.mongodb.com/</a></li>
<li>Pandas dataframe library for Python: <a href="https://pandas.pydata.org/">https://pandas.pydata.org/</a></li>
<li>Polars dataframe library for Python: <a href="https://pola.rs/">https://pola.rs/</a></li>
<li>PostgreSQL relational database manager: <a href="https://www.postgresql.org/">https://www.postgresql.org/</a></li>
<li>SQLFluff (a linting tool for SQL): <a href="https://sqlfluff.com/">https://sqlfluff.com/</a></li>
<li>SQLModel object-relational mapper: <a href="https://sqlmodel.tiangolo.com/">https://sqlmodel.tiangolo.com/</a></li>
<li>SQLite JSON functions: <a href="https://sqlite.org/json1.html">https://sqlite.org/json1.html</a></li>
<li>SQLite date and time functions: <a href="https://www.sqlite.org/lang_datefunc.html">https://www.sqlite.org/lang_datefunc.html</a></li>
<li>SQLite math functions: <a href="https://www.sqlite.org/lang_mathfunc.html">https://www.sqlite.org/lang_mathfunc.html</a></li>
<li>SQLite relational database manager: <a href="https://sqlite.org/">https://sqlite.org/</a></li>
<li>SQLite scalar functions: <a href="https://www.sqlite.org/lang_corefunc.html">https://www.sqlite.org/lang_corefunc.html</a></li>
<li>SQLite string formatting utilities: <a href="https://sqlite.org/printf.html">https://sqlite.org/printf.html</a></li>
<li>SQLite window functions: <a href="https://sqlite.org/windowfunctions.html">https://sqlite.org/windowfunctions.html</a></li>
<li>Software Carpentry lesson on the Unix shell for novices: <a href="https://swcarpentry.github.io/shell-novice/">https://swcarpentry.github.io/shell-novice/</a></li>
<li>Sqitch database migration manager: <a href="https://sqitch.org/">https://sqitch.org/</a></li>
<li>Wikipedia description of SQL: <a href="https://en.wikipedia.org/wiki/SQL">https://en.wikipedia.org/wiki/SQL</a></li>
<li>XKCD cartoon about SQL injection attacks: <a href="https://xkcd.com/327/">https://xkcd.com/327/</a></li>
<li>sqlparse (a SQL parsing module written in Python): <a href="https://pypi.org/project/sqlparse/">https://pypi.org/project/sqlparse/</a></li>
</ul>
</section>
    </main>
    <footer>
  <i class="fa fa-copyright"></i> 2024 Greg Wilson
  &middot;
  <a href="mailto:gvwilson@third-bit.com"><i class="fas fa-envelope-square" aria-hidden="true" title="author email"></i></a>
  <a href="https://github.com/gvwilson/sql-tutorial"><i class="fab fa-github" aria-hidden="true" title="GitHub repository"></i></a>
  <a href="license/"><i class="fab fa-creative-commons-by" aria-hidden="true" title="license"></i></a>
  &middot;
  <time datetime="2024-02-14">Last built 2024-02-14</time>
</footer>

  </body>
</html>
